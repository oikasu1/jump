<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ü•∑ÁÉèË°£Ë°å(Ë≤™È£üËõá-Â≠∏Ê†°ÂÆ¢‰∫ã100Âè•)</title>
    <link href="https://oikasu1.github.io/kasuexam/kasu/fonts/twhei.css" rel="stylesheet">
	<script src="data.js"></script>
    <style>
        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f5f5f5;
            color: #333;
			user-select: none;
        }

        #gameSettings {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 10px;
            margin-top: 10px;
            margin-bottom: 30px;
            max-width: 400px;
            width: 100%;			          
        }

        #gameSettings h2 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #2c3e50;
            font-size: 24px;
            text-align: center;
        }

        #gameSettings div {
            margin-bottom: 0px;
        }

        #gameSettings p {
            margin-left: 40px;

        }

        #gameSettings label {
            display: inline-block;
            width: 80px;
            text-align: right;
            margin-left: 10px;
            font-weight: bold;
        }

        #gameSettings select {
            width: 250px;
            padding: 5px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #fff;
            font-size: 16px;
        }

        button {
            padding: 8px 8px;
            margin: 5px 5px;
            font-size: 16px;
            cursor: pointer;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #2980b9;
        }

        @media (max-width: 480px) {

            #gameSettings,
            #speedSelection {
                padding: 20px;
            }

            #gameSettings select {
                width: 150px;
            }

            button {
                padding: 8px 8px;
                margin: 5px 5px;
            }
        }

        #gameCanvas {
            border: 2px solid #bbb;
            background-color: #fcfcfc;
            display: none;
        }

        #container {
            display: none;
            position: relative;
            text-align: center;
			margin: 0;
			transition: transform 0.3s ease;
        }

        #header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-bottom: 10px;
            position: relative;
        }

        #scoreDisplay,
        #wordDisplay,
        #timeDisplay {
            font-size: 14px;
            color: #555;
        }

        #wordDisplay {
            font-size: 18px;
            border: 1px solid #bbb;
            padding: 5px 10px;
            border-radius: 50px;
            color: #555;
            background-color: #fcfcfc;
        }

        .food-label {
            position: absolute;
            font-size: 18px;
        }

        select {
            margin: 5px 10px;
            padding: 5px;
        }

        #startButton {
            display: block;
            margin: 10px auto;
            padding: 10px 20px;
            font-size: 18px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #startButton:hover {
            background-color: #45a049;
        }


		.modal {
		  display: none;
		  position: fixed;
		  z-index: 1000;
		  left: 0;
		  top: 0;
		  width: 100%;
		  height: 100%;
		  background-color: rgba(0,0,0,0.4);
		}

		.modal-content {
		  background-color: #fefefe;
		  margin: 15% auto;
		  padding: 20px;
		  border: 1px solid #888;
		  width: 80%;
		  max-width: 300px;
		  border-radius: 10px;
		  text-align: center;
		  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
		}

		#modalTitle {
		  color: #333;
		  margin-top: 0;
		}

		#modalMessage {
		  color: #666;
		  margin-bottom: 20px;
		}

		#starRating {
		  font-size: 24px;
		  color: #FFD700;
		  margin-bottom: 20px;
		  display: flex;
		  flex-wrap: wrap;
		  justify-content: center;
		  gap: 5px;
		}

		.star {
		  display: inline-block;
		}
		#modalClose {
		  background-color: #4CAF50;
		  color: white;
		  padding: 10px 20px;
		  border: none;
		  border-radius: 5px;
		  cursor: pointer;
		  font-size: 16px;
		  transition: background-color 0.3s;
		}

		#modalClose:hover {
		  background-color: #45a049;
		}
    </style>
</head>

<body>

    <div id="gameSettings">
        <h2>ü•∑Â≠∏Ê†°ÂÆ¢‰∫ãüíØ</h2>
        <div>
            <label for="lessonSelect">ÈóúÂç°Ôºö</label>
            <select id="lessonSelect"></select>
        </div>
        <div>
            <label for="questionSelect">È°åÁõÆÔºö</label>
            <select id="questionSelect"></select>
        </div>
        <div>
            <label for="answerSelect">Á≠îÊ°àÔºö</label>
            <select id="answerSelect"></select>
        </div>
        <div>
            <label for="blockCountSelect">Êï∏ÈáèÔºö</label>
            <select id="blockCountSelect">
                <option value="2">2</option>
                <option value="3" selected>3</option>
				<option value="4">4</option>
            </select>
        </div>
        <div>
            <label for="speedSelect">ÈÄüÂ∫¶Ôºö</label>
            <select id="speedSelect">
			    <option value="slow">ÊÖ¢ÊÖ¢Ë∂ñ ü¶•</option>
                <option value="slow">ÂØ¨ÂØ¨ üêà</option>
                <option value="normal" selected>ÊôÆÈÄö ü¶ì</option>
                <option value="quick">ÁúüÁ∑ä üõ©Ô∏è</option>
                <option value="fast">Ë∂≥Á∑ä üöÄ</option>
            </select>
        </div>
        <button id="startButton">Ë≤™È£üËõá ;)</button>
    </div>




    <div id="container">
        <div id="header">
            <div id="scoreDisplay">‚ú®ÂæóÂàÜ: 0</div>
            <div id="wordDisplay"></div>
            <div id="timeDisplay">‚è±Ô∏èÊôÇÈñì: 0</div>
        </div>
        <canvas id="gameCanvas"></canvas>
        <div id="correctFoodLabel" class="food-label"></div>
        <div id="wrongFoodLabel" class="food-label"></div>
        <div id="wrongFoodLabel2" class="food-label"></div>
		<div id="wrongFoodLabel3" class="food-label"></div>
    </div>


	<div id="customModal" class="modal">
	  <div class="modal-content">
		<h2 id="modalTitle"></h2>
		<p id="modalMessage"></p>
		<div id="starRating"></div>
		<button id="modalClose">ÈóúÈñâ</button>
	  </div>
	</div>

    <script>


/*
const myData = `
ÂàÜÈ°û	ÂúãË™û	ÂÆ¢Ë™û	ÊãºÈü≥	Ê≥®Èü≥	Èü≥Ê™î
‰∏Ä„ÄÅÂïèÂ•Ω 00ÁôæÂè•	‰Ω†Â•Ω	‰Ω†Óá¥ÓàãÓàòÓàµÂ•ΩÓÜ•ÓáÇÓáß	henÀã hooÀÜ	ÓÑäÓÑòÓÑûÀã ÓÑäÓÑóÀÜ	k009.mp3
‰∏Ä„ÄÅÂïèÂ•Ω 00ÁôæÂè•	ËÄÅÂ∏´Êó©	ÂÖàÓá∑ÓàÜÓàóÓà¥ÁîüÓáæÓàãÓàòÓà¥†¢ïÓÜ±ÓáàÓá£Êó©ÓÜ≠ÓáÇÓáß	sienÀá senÀá ngauÀã zooÀÜ	ÓÑçÓÑ¢ÓÑùÀá ÓÑîÓÑòÓÑûÀá ÓÑ¶ÓÑõÀã ÓÑíÓÑóÀÜ	k010.mp3
`;
*/

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const wordDisplay = document.getElementById('wordDisplay');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const timeDisplay = document.getElementById('timeDisplay');
        const correctFoodLabel = document.getElementById('correctFoodLabel');
        const wrongFoodLabel = document.getElementById('wrongFoodLabel');
        const container = document.getElementById('container');

        let gridSize = 20;
        let snake, correctFood, wrongFood, dx, dy, score, baseSpeed, gameSpeed, gameInterval, elapsedTime, startTime;
        let currentWord, currentCorrectTranslation, currentWrongTranslation;
        let isAdjacent;

        const rightAudio = new Audio('right.mp3');
        const wrongAudio = new Audio('wrong.mp3');

        function playAudio(audio) {
            audio.currentTime = 0;
            audio.play();
        }

        let currentAudio = null;
        let headers = [];
        let wordPairs = [];
        let lessons = {};
        let allWords = [];
        let unusedWords = [];
        let isGameRunning = false;
		let iosTouch = false;
		let isSnakeYellow = false;
		let colorChangeTimeout;



        function playTwice() {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                currentAudio.play();
                currentAudio.onended = function() {
                    if (this.playCount === undefined) {
                        this.playCount = 1;
                        currentAudio.play(); // Êí≠ÊîæÁ¨¨‰∫åÊ¨°
                    } else {
                        this.playCount = undefined; // ÈáçÁΩÆË®àÊï∏
                    }
                };
            }
        }

		function processMyData() {
			const lines = myData.trim().split('\n');
			headers = lines[0].trim().split(/\t/);
			let wordId = 0;
			allWords = []; // ÈáçÁΩÆ
			lessons = {}; // ÈáçÁΩÆ lessons Â∞çË±°

			// ËºîÂä©ÂáΩÊï∏ÔºöÊ™¢Êü•ÂñÆË©ûÊòØÂê¶ÈáçË§á
			const isDuplicate = (word, wordList) => {
				return wordList.some(w => w.ÂúãË™û === word.ÂúãË™û && w.ÂÆ¢Ë™û === word.ÂÆ¢Ë™û);
			};

			lines.slice(1).forEach((line, index) => {
				const parts = line.trim().split(/\t/);
				if (parts.length >= 3) {
					const [lesson, ...rest] = parts;
					if (!lessons[lesson]) {
						lessons[lesson] = [];
					}
					const newWord = {
						id: wordId++,
						lesson,
						...Object.fromEntries(headers.slice(1).map((header, i) => [header, rest[i] || '']))
					};
					if (!isDuplicate(newWord, lessons[lesson])) {
						lessons[lesson].push(newWord);
						if (!isDuplicate(newWord, allWords)) {
							allWords.push(newWord);
						}
					}
				} else if (parts.length === 2) {
					const [value1, value2] = parts;
					const lesson = `Á¨¨${Math.floor(index / 10) + 1}ÁµÑ`;
					if (!lessons[lesson]) {
						lessons[lesson] = [];
					}
					const newWord = {
						id: wordId++,
						lesson,
						[headers[0]]: value1,
						[headers[1]]: value2
					};
					if (!isDuplicate(newWord, lessons[lesson])) {
						lessons[lesson].push(newWord);
						if (!isDuplicate(newWord, allWords)) {
							allWords.push(newWord);
						}
					}
				}
			});
			populateSelects();
		}
        function populateSelects() {
            const lessonSelect = document.getElementById('lessonSelect');
            const questionSelect = document.getElementById('questionSelect');
            const answerSelect = document.getElementById('answerSelect');

            // Ê∏ÖÁ©∫ÁèæÊúâÈÅ∏È†Ö
            lessonSelect.innerHTML = '';
            questionSelect.innerHTML = '';
            answerSelect.innerHTML = '';

            // Ê∑ªÂä†"ÂÖ®ÈÉ®"ÈÅ∏È†ÖÂà∞Ë™≤Âà•
            const allOption = document.createElement('option');
            allOption.value = 'all';
            allOption.textContent = 'ÂÖ®ÈÉ®';
            lessonSelect.appendChild(allOption);

            // Ê∑ªÂä†ÂÖ∂‰ªñË™≤Á®ãÈÅ∏È†Ö
            for (const lesson in lessons) {
                const option = document.createElement('option');
                option.value = lesson;
                option.textContent = lesson;
                lessonSelect.appendChild(option);
            }

            // Áç≤ÂèñÈùû"Èü≥Ê™î"Âíå"ÂàÜÈ°û"ÁöÑÊ®ôÈ°å
            const validHeaders = headers.filter(header => header !== 'Èü≥Ê™î' && header !== 'ÂàÜÈ°û');

			// Ê™¢Êü•ÊòØÂê¶ÂåÖÂê´ÊâÄÊúâÂøÖË¶ÅÁöÑÊ®ôÈ°å
			const hasAllRequiredHeaders = ['ÂúãË™û', 'Ê≥®Èü≥'].every(header => validHeaders.includes(header));

            // Â°´ÂÖÖÈ°åÁõÆÈÅ∏ÂñÆ
            validHeaders.forEach(header => {
                const questionOption = document.createElement('option');
                questionOption.value = header;
                questionOption.textContent = header;
                questionSelect.appendChild(questionOption);
            });

			// Ë®≠ÁΩÆÈªòË™çÈÅ∏È†Ö
			if (hasAllRequiredHeaders) {
				// Â¶ÇÊûúÂåÖÂê´ÊâÄÊúâÂøÖË¶ÅÁöÑÊ®ôÈ°å,Ë®≠ÁΩÆÈªòË™çÂÄº
				questionSelect.value = 'Ê≥®Èü≥';
			} else if (questionSelect.options.length > 0) {
				// Âê¶Ââá,ÈÅ∏ÊìáÁ¨¨‰∏ÄÂÄãÈÅ∏È†Ö
				questionSelect.selectedIndex = 0;
			}

			// ÂàùÂßãÂ°´ÂÖÖÁ≠îÊ°àÈÅ∏ÂñÆ
			updateAnswerSelect();

			// Â¶ÇÊûúÂåÖÂê´ÊâÄÊúâÂøÖË¶ÅÁöÑÊ®ôÈ°å,Ë®≠ÁΩÆÁ≠îÊ°àÈªòË™çÂÄºÁÇ∫"ÂúãË™û"
			if (hasAllRequiredHeaders) {
				answerSelect.value = 'ÂúãË™û';
			}

			// Ê∑ªÂä†‰∫ã‰ª∂Áõ£ËÅΩÂô®
			questionSelect.addEventListener('change', updateAnswerSelect);
		}

        function updateAnswerSelect() {
            const questionSelect = document.getElementById('questionSelect');
            const answerSelect = document.getElementById('answerSelect');
            const selectedQuestion = questionSelect.value;
            const validHeaders = headers.filter(header => header !== 'Èü≥Ê™î' && header !== 'ÂàÜÈ°û');

            // ÂÑ≤Â≠òÁ≠îÊ°àÈÅ∏ÂñÆÁöÑÁï∂ÂâçÈÅ∏Êìá
            const currentAnswerSelection = answerSelect.value;

            // Ê∏ÖÁ©∫Á≠îÊ°àÈÅ∏ÂñÆ
            answerSelect.innerHTML = '';

            // ÈáçÊñ∞Â°´ÂÖÖÁ≠îÊ°àÈÅ∏ÂñÆÔºåÊéíÈô§Âú®È°åÁõÆ‰∏≠ÈÅ∏ÊìáÁöÑÈÅ∏È†Ö
            validHeaders.forEach(header => {
                if (header !== selectedQuestion) {
                    const option = document.createElement('option');
                    option.value = header;
                    option.textContent = header;
                    answerSelect.appendChild(option);
                }
            });

            // Â¶ÇÊûúÁ≠îÊ°àÈÅ∏ÂñÆÁöÑ‰πãÂâçÈÅ∏Êìá‰ªçÁÑ∂ÂèØÁî®ÔºåÂâáÈÅ∏‰∏≠ÂÆÉ
            if (Array.from(answerSelect.options).some(option => option.value === currentAnswerSelection)) {
                answerSelect.value = currentAnswerSelection;
            } else {
                // Âê¶ÂâáÔºåÈÅ∏ÊìáÁ¨¨‰∏ÄÂÄãÂèØÁî®ÈÅ∏È†Ö
                answerSelect.selectedIndex = 0;
            }
        }

        function updateSelectOptions(changedSelect, otherSelect) {
            const changedValue = changedSelect.value;
            const otherValue = otherSelect.value;
            const validHeaders = headers.filter(header => header !== 'Èü≥Ê™î' && header !== 'ÂàÜÈ°û');

            // ÂÑ≤Â≠òÂÖ∂‰ªñÈÅ∏ÂñÆÁöÑÁï∂ÂâçÈÅ∏Êìá
            const currentOtherSelection = otherSelect.value;

            // Ê∏ÖÁ©∫ÂÖ∂‰ªñÈÅ∏ÂñÆ
            otherSelect.innerHTML = '';

            // ÈáçÊñ∞Â°´ÂÖÖÂÖ∂‰ªñÈÅ∏ÂñÆÔºåÊéíÈô§Â∑≤Âú®ËÆäÊõ¥ÁöÑÈÅ∏ÂñÆ‰∏≠ÈÅ∏ÊìáÁöÑÈÅ∏È†Ö
            validHeaders.forEach(header => {
                if (header !== changedValue) {
                    const option = document.createElement('option');
                    option.value = header;
                    option.textContent = header;
                    otherSelect.appendChild(option);
                }
            });

            // Â¶ÇÊûúÂÖ∂‰ªñÈÅ∏ÂñÆÁöÑ‰πãÂâçÈÅ∏Êìá‰ªçÁÑ∂ÂèØÁî®ÔºåÂâáÈÅ∏‰∏≠ÂÆÉ
            if (Array.from(otherSelect.options).some(option => option.value === currentOtherSelection)) {
                otherSelect.value = currentOtherSelection;
            } else {
                // Âê¶ÂâáÔºåÈÅ∏ÊìáÁ¨¨‰∏ÄÂÄãÂèØÁî®ÈÅ∏È†Ö
                otherSelect.selectedIndex = 0;
            }
        }

        function getWordStats(wordId) {
            const stats = JSON.parse(localStorage.getItem(`word_${wordId}`)) || {
                correct: 0,
                wrong: 0
            };
            return stats;
        }

        function updateWordStats(wordId, isCorrect) {
            const stats = getWordStats(wordId);
            if (isCorrect) {
                stats.correct++;
            } else {
                stats.wrong++;
            }
            localStorage.setItem(`word_${wordId}`, JSON.stringify(stats));
        }

        // Âú®ÊñáÊ™îÂä†ËºâÂÆåÊàêÂæåÂü∑Ë°å
        window.onload = function() {
            processMyData();
            populateSelects();

            // ÁÇ∫ÈñãÂßãÈÅäÊà≤ÊåâÈàïÊ∑ªÂä†‰∫ã‰ª∂Áõ£ËÅΩÂô®
            document.getElementById('startButton').addEventListener('click', function() {
                const speed = document.getElementById('speedSelect').value;				
                startGame(speed);
				document.addEventListener('click', playTwice);
            });
        };

		function initGame() {
			snake = [{ x: 10, y: 10 }];
			dx = 0;
			dy = 0;
			score = 0;
			gameSpeed = baseSpeed;
			startTime = Date.now();
			resetUnusedWords();
			generateNewWord();
		}

        function resetUnusedWords() {
            unusedWords = [...wordPairs];
        }

        function generateNewWord() {			
            playAudio(rightAudio);

            // ÂÅúÊ≠¢Áï∂ÂâçÊ≠£Âú®Êí≠ÊîæÁöÑÈü≥Ê™îÔºàÂ¶ÇÊûúÊúâÔºâ
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
            }

            // Â¶ÇÊûúÊâÄÊúâÂñÆË©ûÈÉΩÂ∑≤Á∂ì‰ΩøÁî®ÈÅéÔºåÈáçÁΩÆÊú™‰ΩøÁî®ÂñÆË©ûÂàóË°®
            if (unusedWords.length === 0) {
                resetUnusedWords();
            }


            // ÂæûÊú™‰ΩøÁî®ÁöÑÂñÆË©û‰∏≠Èö®Ê©üÈÅ∏Êìá‰∏ÄÂÄã
            const randomIndex = Math.floor(Math.random() * unusedWords.length);
            const selectedWord = unusedWords[randomIndex];

            // ÂæûÊú™‰ΩøÁî®ÂñÆË©ûÂàóË°®‰∏≠ÁßªÈô§ÈÄôÂÄãÂñÆË©û
            unusedWords.splice(randomIndex, 1);

            currentWord = selectedWord.question;
            currentCorrectTranslation = selectedWord.answer;
            currentWordId = selectedWord.id;

            wordDisplay.textContent = `ü•∑ ${currentWord}`;


            // Ê™¢Êü•ÊòØÂê¶ÊúâÂ∞çÊáâÁöÑÈü≥Ê™î‰∏¶Ë®≠ÁΩÆ
            if (selectedWord['Èü≥Ê™î']) {
                //currentAudio = new Audio(`https://oikasu1.github.io/kasu100/${selectedWord['Èü≥Ê™î']}`);
				let audioUrl = getAudioUrl(selectedWord['Èü≥Ê™î']);
				currentAudio = new Audio(audioUrl);

                playTwice(); // Áõ¥Êé•Ë™øÁî® playTwice()
            }

            // Áç≤ÂèñÈÅ∏ÊìáÁöÑÊñπÂ°äÊï∏Èáè
            const selectedBlockCount = parseInt(document.getElementById('blockCountSelect').value);

            // ÁîüÊàêÊ≠£Á¢∫Á≠îÊ°àÁöÑ‰ΩçÁΩÆ
            correctFood = generateFoodPosition();

            // ÁîüÊàêÈåØË™§Á≠îÊ°àÁöÑ‰ΩçÁΩÆÔºåÁ¢∫‰øù y Â∫ßÊ®ô‰∏çÂêå
			// ÁîüÊàêÈåØË™§Á≠îÊ°àÁöÑ‰ΩçÁΩÆ
			wrongFood = generateFoodPosition();
			while (wrongFood.y === correctFood.y) {
				wrongFood = generateFoodPosition();
			}

			// ÁîüÊàêÁ¨¨‰∫åÂÄãÈåØË™§Á≠îÊ°àÁöÑ‰ΩçÁΩÆ
			if (selectedBlockCount >= 3) {
				wrongFood2 = generateFoodPosition();
				while (wrongFood2.y === correctFood.y || wrongFood2.y === wrongFood.y) {
					wrongFood2 = generateFoodPosition();
				}
			} else {
				wrongFood2 = null;
			}


			// ÁîüÊàêÁ¨¨‰∏âÂÄãÈåØË™§Á≠îÊ°àÁöÑ‰ΩçÁΩÆ
			if (selectedBlockCount === 4) {
				wrongFood3 = generateFoodPosition();
				while (wrongFood3.y === correctFood.y || wrongFood3.y === wrongFood.y || 
					   (wrongFood2 && wrongFood3.y === wrongFood2.y)) {
					wrongFood3 = generateFoodPosition();
				}
			} else {
				wrongFood3 = null;
			}



            // Ë®≠ÁΩÆÈ£üÁâ©Ê®ôÁ±§‰ΩçÁΩÆÂíåÂÖßÂÆπ
            setFoodLabelPosition(correctFoodLabel, correctFood, currentCorrectTranslation);

            // ÁÇ∫ÈåØË™§Á≠îÊ°àÁîüÊàê‰∏çÂêåÁöÑÁøªË≠Ø
            let wrongTranslations = wordPairs.filter(pair => pair.id !== selectedWord.id).map(pair => pair.answer);
            currentWrongTranslation = wrongTranslations[Math.floor(Math.random() * wrongTranslations.length)];
            setFoodLabelPosition(wrongFoodLabel, wrongFood, currentWrongTranslation);


			if (selectedBlockCount >= 3 && wrongFood2) {
				let secondWrongTranslation;
				do {
					secondWrongTranslation = wrongTranslations[Math.floor(Math.random() * wrongTranslations.length)];
				} while (secondWrongTranslation === currentWrongTranslation);
				setFoodLabelPosition(document.getElementById('wrongFoodLabel2'), wrongFood2, secondWrongTranslation);
				document.getElementById('wrongFoodLabel2').style.display = 'block';
			} else {
				document.getElementById('wrongFoodLabel2').style.display = 'none';
			}

			if (selectedBlockCount === 4 && wrongFood3) {
				let thirdWrongTranslation;
				do {
					thirdWrongTranslation = wrongTranslations[Math.floor(Math.random() * wrongTranslations.length)];
				} while (thirdWrongTranslation === currentWrongTranslation || 
						 thirdWrongTranslation === document.getElementById('wrongFoodLabel2').textContent);
				setFoodLabelPosition(document.getElementById('wrongFoodLabel3'), wrongFood3, thirdWrongTranslation);
				document.getElementById('wrongFoodLabel3').style.display = 'block';
			} else {
				document.getElementById('wrongFoodLabel3').style.display = 'none';
			}
		}





// ÂèñÂæóË∑ØÂæë;
function getAudioUrl(audioFileInfo) {
    if (audioFileInfo.endsWith('.k100')) {
        return `https://oikasu1.github.io/kasu100/${audioFileInfo.replace('.k100', '.mp3')}`;
    } else if (audioFileInfo.endsWith('.kasu')) {
        return `https://oikasu1.github.io/snd/mp3kasu/${audioFileInfo.replace('.kasu', '.mp3')}`;
    } else if (audioFileInfo.endsWith('.holo')) {
        return `https://oikasu1.github.io/snd/mp3holo/${audioFileInfo.replace('.holo', '.mp3')}`;
    } else if (audioFileInfo.endsWith('.mp3')) {
        return audioFileInfo;
    } else {
        let langCode, text;
        
        // Êñ∞Â¢ûÁöÑ TTS ËôïÁêÜÈÇèËºØ
        const ttsMatch = audioFileInfo.match(/^tts\s*[:=]?\s*\(?\s*(\w+)\s*\)?$/i);
        if (ttsMatch) {
            langCode = ttsMatch[1].toLowerCase();
            text = gameData[currentQuestionIndex][headers.indexOf(langCode)];
        } else {
            switch (audioFileInfo) {
                case 'zh':
                    langCode = 'zh-TW';
                    text = gameData[currentQuestionIndex][headers.indexOf('ÂúãË™û')];
                    break;
                case 'en':
                case 'Ëã±':
                    langCode = 'en';
                    text = gameData[currentQuestionIndex][headers.indexOf('Ëã±Ë™û')] || gameData[currentQuestionIndex][headers.indexOf('ÁæéË™û')];
                    break;
                case 'jp':
                case 'Êó•':
                    langCode = 'ja';
                    text = gameData[currentQuestionIndex][headers.indexOf('Êó•Ë™û')];
                    break;
                case 'es':
                case 'Ë•ø':
                    langCode = 'es-ES';
                    text = gameData[currentQuestionIndex][headers.indexOf('Ë•øÁè≠ÁâôË™û')];
                    break;
                case 'vi':
                case 'Ë∂ä':
                    langCode = 'vi';
                    text = gameData[currentQuestionIndex][headers.indexOf('Ë∂äÂçóË™û')];
                    break;
                case 'ko':
                case 'Èüì':
                    langCode = 'vi';
                    text = gameData[currentQuestionIndex][headers.indexOf('ÈüìË™û')];
                    break;
                case 'in':
                case 'Âç∞':
                    langCode = 'id';
                    text = gameData[currentQuestionIndex][headers.indexOf('Âç∞Â∞ºË™û')];
                    break;
                default:
                    console.warn('Êú™Áü•ÁöÑÈü≥È†ªÊ†ºÂºè:', audioFileInfo);
                    return null;
            }
        }
        
        if (langCode && text) {
            return `https://translate.google.com/translate_tts?ie=UTF-8&tl=${langCode}&client=tw-ob&q=${encodeURIComponent(text)}`;
        } else {
            console.warn('ÁÑ°Ê≥ïÁ¢∫ÂÆöË™ûË®ÄÊàñÊâæ‰∏çÂà∞Â∞çÊáâÁöÑÊñáÊú¨');
            return null;
        }
    }
}


        function generateFoodPosition() {
            const x = Math.floor(Math.random() * (canvas.width / gridSize));
            const y = Math.floor(Math.random() * (canvas.height / gridSize));
            return {
                x,
                y
            };
        }

        function checkCollision() {
            const head = snake[0];
            return (
                head.x < 0 || head.x >= canvas.width / gridSize ||
                head.y < 0 || head.y >= canvas.height / gridSize ||
                snake.slice(1).some(segment => segment.x === head.x && segment.y === head.y)
            );
        }



        function generateFoodPositions(count) {
            const positions = [];
            const maxY = canvas.height / gridSize - 1;
            const availableYs = [...Array(maxY + 1).keys()];

            for (let i = 0; i < count; i++) {
                if (availableYs.length === 0) {
                    console.warn('Not enough vertical space for all blocks');
                    break;
                }
                const yIndex = Math.floor(Math.random() * availableYs.length);
                const y = availableYs.splice(yIndex, 1)[0];
                const x = Math.floor(Math.random() * (canvas.width / gridSize));
                positions.push({
                    x,
                    y
                });
            }

            return positions;
        }


		function setFoodLabelPosition(label, food, text) {
			const labelOffset = 5; // ÂèØ‰ª•Ê†πÊìöÈúÄË¶ÅË™øÊï¥ÈÄôÂÄãÂÄº
			const canvasMiddle = canvas.width / 2;

			if (food.x * gridSize >= canvasMiddle) {
				// È£üÁâ©Âú®Áï´Â∏ÉÂè≥ÂçäÈÉ®ÂàÜÔºåÊ®ôÁ±§ÊîæÂú®Â∑¶ÈÇä
				label.style.right = `${canvas.width - food.x * gridSize + labelOffset}px`;
				label.style.left = 'auto';
			} else {
				// È£üÁâ©Âú®Áï´Â∏ÉÂ∑¶ÂçäÈÉ®ÂàÜÔºåÊ®ôÁ±§ÊîæÂú®Âè≥ÈÇä
				label.style.left = `${food.x * gridSize + gridSize + labelOffset}px`;
				label.style.right = 'auto';
			}

			// Ë®≠ÁΩÆÂûÇÁõ¥‰ΩçÁΩÆÂíåÊñáÂ≠ó
			label.style.top = `${food.y * gridSize + 44}px`;
			label.textContent = text;
		}

		function drawSnake() {
		  snake.forEach((segment, index) => {
			// Â¶ÇÊûúËõáËôïÊñº"ÈªÉËâ≤ÁãÄÊÖã"ÔºåÂâá‰ΩøÁî®ÈªÉËâ≤Áπ™Ë£Ω
			ctx.fillStyle = isSnakeYellow ? 'gold' : 'green';
			ctx.fillRect(segment.x * gridSize, segment.y * gridSize, gridSize - 2, gridSize - 2);
			// Âú®ËõáÈ†≠‰∏äÈ°ØÁ§∫ÂæóÂàÜ
			if (index === 0) {
			  ctx.fillStyle = 'white';
			  ctx.font = '12px Arial';
			  ctx.textAlign = 'center';
			  ctx.textBaseline = 'middle';
			  ctx.fillText(score.toString(), (segment.x * gridSize) + (gridSize / 2), (segment.y * gridSize) + (gridSize / 2));
			}
		  });
		}

		function drawFood() {
			ctx.fillStyle = 'red';
			ctx.fillRect(correctFood.x * gridSize, correctFood.y * gridSize, gridSize - 2, gridSize - 2);
			ctx.fillRect(wrongFood.x * gridSize, wrongFood.y * gridSize, gridSize - 2, gridSize - 2);

			const selectedBlockCount = parseInt(document.getElementById('blockCountSelect').value);
			if (selectedBlockCount >= 3 && wrongFood2) {
				ctx.fillRect(wrongFood2.x * gridSize, wrongFood2.y * gridSize, gridSize - 2, gridSize - 2);
			}
			if (selectedBlockCount === 4 && wrongFood3) {
				ctx.fillRect(wrongFood3.x * gridSize, wrongFood3.y * gridSize, gridSize - 2, gridSize - 2);
			}
		}

		function moveSnake() {
		  const head = { x: snake[0].x + dx, y: snake[0].y + dy };
		  snake.unshift(head);

		  if (head.x === correctFood.x && head.y === correctFood.y) {
			score++;
			iosTouch = false;
			updateWordStats(currentWordId, true);
			
			// Â∞áËõáËÆäÁÇ∫ÈªÉËâ≤
			isSnakeYellow = true;
			
			// Ê∏ÖÈô§‰πãÂâçÁöÑË®àÊôÇÂô®ÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
			if (colorChangeTimeout) {
			  clearTimeout(colorChangeTimeout);
			}
			
			// Ë®≠ÁΩÆÊñ∞ÁöÑË®àÊôÇÂô®Ôºå1ÁßíÂæåÂ∞áËõáËÆäÂõûÁ∂†Ëâ≤
			colorChangeTimeout = setTimeout(() => {
			  isSnakeYellow = false;
			}, 500);

			generateNewWord();
			updateScore();
			// Êõ¥Êñ∞ÈÅäÊà≤ÈÄüÂ∫¶
			gameSpeed = Math.max(150, baseSpeed - score * 2);
			clearInterval(gameInterval);
			gameInterval = setInterval(gameLoop, gameSpeed);
		  } else if (head.x === wrongFood.x && head.y === wrongFood.y ||
			(wrongFood2 && head.x === wrongFood2.x && head.y === wrongFood2.y) ||
			(wrongFood3 && head.x === wrongFood3.x && head.y === wrongFood3.y)) {
			updateWordStats(currentWordId, false);
			endGame();
		  } else {
			snake.pop();
		  }
		}

        function gameLoop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            moveSnake();
            drawSnake();
            drawFood();

            updateTime();

            if (checkCollision()) {
                endGame();
            }
        }



        function endGame() {
            playAudio(wrongAudio);
			iosTouch = false;

	  	   if (colorChangeTimeout) {
			 clearTimeout(colorChangeTimeout);
		   }

            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
            }
            showCustomModal('ü•∑ÈÅäÊà≤ÁÖûÂïä', `üéâ‰Ω†ÂæóËëó: ${score} ÂàÜ`, score);
            clearInterval(gameInterval);
            isGameRunning = false;
            document.removeEventListener('keydown', handleKeyDown);
            // ÁßªÈô§ÈªûÊìä‰∫ã‰ª∂Áõ£ËÅΩÂô®
            document.removeEventListener('click', playTwice);
        }




        function handleKeyDown(event) {
            if (!isGameRunning) return;

            switch (event.key) {
                case 'ArrowUp':
                    if (dy === 0) {
                        dx = 0;
                        dy = -1;
                    }
                    break;
                case 'ArrowDown':
                    if (dy === 0) {
                        dx = 0;
                        dy = 1;
                    }
                    break;
                case 'ArrowLeft':
                    if (dx === 0) {
                        dx = -1;
                        dy = 0;
                    }
                    break;
                case 'ArrowRight':
                    if (dx === 0) {
                        dx = 1;
                        dy = 0;
                    }
                    break;
                case ' ': // Á©∫Ê†ºÈçµ
                    event.preventDefault(); // Èò≤Ê≠¢È†ÅÈù¢ÊªæÂãï
                    playTwice();
                    break;
            }
        }

		

		function isIOS() {
			const userAgent = navigator.userAgent.toLowerCase();
			const isIOSDevice = /iphone|ipod/.test(userAgent);  // iPhone Âíå iPod Ê™¢Ê∏¨
			const isIPad = /ipad/.test(userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);  // iPad Ê™¢Ê∏¨
			return isIOSDevice || isIPad;
		}





        function handleTouchStart(event) {
            touchStartX = event.touches[0].clientX;
            touchStartY = event.touches[0].clientY;

			if (isIOS() && !iosTouch) {
				playTwice();
				iosTouch = true;
			}

        }

        function handleTouchEnd(event) {
            const touchEndX = event.changedTouches[0].clientX;
            const touchEndY = event.changedTouches[0].clientY;
            const deltaX = touchEndX - touchStartX;
            const deltaY = touchEndY - touchStartY;

            if (Math.abs(deltaX) > Math.abs(deltaY)) {
                if (deltaX > 0 && dx === 0) {
                    dx = 1;
                    dy = 0;
                } else if (deltaX < 0 && dx === 0) {
                    dx = -1;
                    dy = 0;
                }
            } else {
                if (deltaY > 0 && dy === 0) {
                    dx = 0;
                    dy = 1;
                } else if (deltaY < 0 && dy === 0) {
                    dx = 0;
                    dy = -1;
                }
            }
        }


        function startGame(speed) {
            const selectedLesson = document.getElementById('lessonSelect').value;
            const selectedQuestion = document.getElementById('questionSelect').value;
            const selectedAnswer = document.getElementById('answerSelect').value;
            const selectedBlockCount = parseInt(document.getElementById('blockCountSelect').value);
            resizeCanvas();

            isGameRunning = true;
            document.addEventListener('keydown', handleKeyDown);

            if (selectedLesson === 'all') {
                wordPairs = allWords;
            } else {
                wordPairs = lessons[selectedLesson];
            }

            // Êõ¥Êñ∞ currentWord Âíå currentCorrectTranslation ÁöÑË®≠ÁΩÆ
            wordPairs = wordPairs.map(word => ({
                ...word,
                question: word[selectedQuestion] || '',
                answer: word[selectedAnswer] || ''
            }));

			switch (speed) {
				case 'slow':
					baseSpeed = 400;
					break;
				case 'normal':
					baseSpeed = 300;
					break;
				case 'quick':
					baseSpeed = 250;
					break;
				case 'fast':
					baseSpeed = 200;
					break;
			}



            document.getElementById('gameSettings').style.display = 'none';
            canvas.style.display = 'block';
            container.style.display = 'block';
            correctFoodLabel.style.display = 'block';
            wrongFoodLabel.style.display = 'block';

            // Ê∑ªÂä†ÈªûÊìä‰∫ã‰ª∂Áõ£ËÅΩÂô®
            //document.addEventListener('click', playTwice);

            resetUnusedWords();
            initGame();
            gameInterval = setInterval(gameLoop, gameSpeed);
        }

        function updateScore() {
            scoreDisplay.textContent = `‚ú®ÂæóÂàÜ: ${score}`;
        }

        function updateTime() {
            elapsedTime = Math.floor((Date.now() - startTime) / 1000);
            timeDisplay.textContent = `‚è±ÊôÇÈñì: ${elapsedTime}`;
        }

        document.addEventListener('keydown', handleKeyDown);
        document.addEventListener('touchstart', handleTouchStart, false);
        document.addEventListener('touchend', handleTouchEnd, false);

        document.body.addEventListener('touchmove', function(e) {
            e.preventDefault();
        }, {
            passive: false
        });



        function resizeCanvas() {
            const canvas = document.getElementById('gameCanvas');
            const container = document.getElementById('container');
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;

            let canvasWidth, canvasHeight, containerWidth, containerHeight;

            if (windowWidth < windowHeight) { // Áõ¥Âºè
                if (windowWidth < 600) { // Â∞èËû¢ÂπïÊâãÊ©ü
                    canvasWidth = 300;
                    canvasHeight = 400;
                    containerWidth = 304;
                    containerHeight = 451;
                } else { // Â§ßËû¢ÂπïÊàñÂπ≥Êùø
                    canvasWidth = 400;
                    canvasHeight = 400;
                    containerWidth = 400;
                    containerHeight = 451;
                }
            } else { // Ê©´Âºè
                if (windowHeight < 450) { // Â∞èËû¢ÂπïÊâãÊ©ü
                    canvasWidth = 450;
                    canvasHeight = 250;
                    containerWidth = 454;
                    containerHeight = 301;
                } else { // Â§ßËû¢ÂπïÊàñÂπ≥Êùø
                    canvasWidth = 400;
                    canvasHeight = 400;
                    containerWidth = 400;
                    containerHeight = 451;
                }
            }

            canvas.width = canvasWidth;
            canvas.height = canvasHeight;

            // Êõ¥Êñ∞ÂÖ®Â±ÄËÆäÈáè gridSize
            gridSize = Math.min(canvasWidth, canvasHeight) / 20;

            scaleElement(container, containerWidth, containerHeight);
        }


        function scaleElement(e, w, h) {
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;

            let scaleX = windowWidth / w * 0.9;
            let scaleY = windowHeight / h * 0.9;

            const scale = Math.min(scaleX, scaleY);

            e.style.transform = `scale(${scale})`;
            container.style.marginTop = "10px";
        }

        // Âú®È†ÅÈù¢ËºâÂÖ•ÂíåË¶ñÁ™óÂ§ßÂ∞èÊîπËÆäÊôÇË™øÁî® resizeCanvas
        window.addEventListener('load', resizeCanvas);
        window.addEventListener('resize', resizeCanvas);



		function showCustomModal(title, message, score) {
		  const modal = document.getElementById('customModal');
		  const modalTitle = document.getElementById('modalTitle');
		  const modalMessage = document.getElementById('modalMessage');
		  const starRating = document.getElementById('starRating');
		  const modalClose = document.getElementById('modalClose');

		  modalTitle.textContent = title;
		  modalMessage.textContent = message;
		  
		  // Ê∏ÖÁ©∫‰πãÂâçÁöÑÊòüÊòü
		  starRating.innerHTML = '';
		  
		  for (let i = 0; i < score; i++) {
			const star = document.createElement('span');
			star.textContent = '‚≠ê';
			star.className = 'star';
			starRating.appendChild(star);
		  }
		  
		  modal.style.display = 'block';

		  modalClose.onclick = function() {
			modal.style.display = 'none';
			// Âú®ÈÄôË£°Ê∑ªÂä†‰ªª‰ΩïÂú®ÈóúÈñâÊ®°ÊÖãÊ°ÜÂæåÈúÄË¶ÅÂü∑Ë°åÁöÑ‰ª£Á¢º
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
            }
			container.style.display = 'none';
			canvas.style.display = 'none';
			document.getElementById('gameSettings').style.display = 'block';
			correctFoodLabel.style.display = 'none';
			wrongFoodLabel.style.display = 'none';
		  }

		  window.onclick = function(event) {
			if (event.target == modal) {
			  modal.style.display = 'none';
			  // Âú®ÈÄôË£°Ê∑ªÂä†‰ªª‰ΩïÂú®ÈóúÈñâÊ®°ÊÖãÊ°ÜÂæåÈúÄË¶ÅÂü∑Ë°åÁöÑ‰ª£Á¢º
				if (currentAudio) {
					currentAudio.pause();
					currentAudio.currentTime = 0;
				}
			  container.style.display = 'none';
			  canvas.style.display = 'none';
			  document.getElementById('gameSettings').style.display = 'block';
			  correctFoodLabel.style.display = 'none';
			  wrongFoodLabel.style.display = 'none';
			}
		  }
		}



let script = document.createElement('script');
script.src = 'wesingmark.js';
script.type = 'text/javascript';
document.head.appendChild(script);








// emoji-detector.js
class EmojiDetector {
    constructor() {
        this.hasEmojiSupport = this.checkEmojiSupport();
        this.needsWebfont = this.checkOSSupport().needsWebfont;
    }

    // Ê™¢Ê∏¨ÊòØÂê¶ÊîØÊè¥Êñ∞Áâàemoji
    checkEmojiSupport() {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const testEmoji = 'ü¶æ';
        
        ctx.fillStyle = '#000000';
        ctx.textBaseline = 'top';
        ctx.font = '32px Arial';
        ctx.fillText(testEmoji, 0, 0);
        
        const emojiData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        return !emojiData.data.every(pixel => pixel === 0);
    }

    // Ê™¢Ê∏¨‰ΩúÊ•≠Á≥ªÁµ±ÁâàÊú¨
    checkOSSupport() {
        const ua = navigator.userAgent;
        const osVersion = {
            iOS: parseInt((ua.match(/OS (\d+)_/i) || [])[1], 10),
            Android: parseInt((ua.match(/Android (\d+)/i) || [])[1], 10),
            Windows: parseInt((ua.match(/Windows NT (\d+\.\d+)/i) || [])[1], 10)
        };
        
        return {
            needsWebfont: (
                (osVersion.iOS && osVersion.iOS < 14) ||
                (osVersion.Android && osVersion.Android < 11) ||
                (osVersion.Windows && osVersion.Windows < 10)
            )
        };
    }

    // ËºâÂÖ• Emoji Â≠óÂûã
    loadEmojiFont() {
        if (!this.hasEmojiSupport || this.needsWebfont) {
            const style = document.createElement('style');
            style.textContent = `
                @font-face {
                    font-family: 'EmojiFont';
                    src: url('https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/fonts/twemoji-mozilla.woff2') format('woff2');
                    font-display: swap;
                }
                
                body {
                    font-family: 'EmojiFont', system-ui, -apple-system, sans-serif;
                }
            `;
            document.head.appendChild(style);
        }
    }

    // ÂàùÂßãÂåñ
    init() {
        this.loadEmojiFont();
    }
}

// Âª∫Á´ãÂÖ®ÂüüÂØ¶‰æã
window.emojiDetector = new EmojiDetector();

document.addEventListener('DOMContentLoaded', () => {
    window.emojiDetector.init();
});
    </script>

</body>

</html>