<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü•∑ÁÉèË°£Ë°åÊàêË™û</title>
	<link rel="stylesheet" href="https://oikasu1.github.io/fonts/twfonts.css">
	<script src="dict.js"></script>
    <style>

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
			user-select: none;
        }
        .container {
            background-color: white;
	  	    justify-content: center;
		    align-items: center;
            padding: 30px 20px 20px 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 800px;
            width: 100%;
        }
        .setup, .game {
            display: none;
        }
        .active {
            display: block;
        }
        select, button {
            margin: 10px;
            padding: 5px 10px;
        }
        .item-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 20px;
        }
        .left-item, .right-item {
            margin: 5px;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
			border: 2px solid #fff;			
        }

        .left-item:hover, .right-item:hover {
            background-color: #c0f0c0;
        }

        .left-item {
			background-color: #f3f3f3;
			font-family: BpmfZihiSans-Regular;	
			font-size: 1.3em;
        }

        .right-item {
			background-color: #eaeaea;
        }

        .selected {
            background-color: #4CAF50;
            color: white;
        }

        .selected:hover {
            background-color: #299920;
            color: white;
        }

        .selected-wrong {
            background-color: #CC5550;
            color: white;
        }

        .selected-wrong:hover {
            background-color: #CC5550;
            color: white;
        }

		.left-item.correct, .right-item.correct {
			background-color: #fff !important;
			color: #1B5E20;
			border: 2px solid #AACC88;
		}

        #start-button, #view-idioms-button {
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

		#next-button-container {
			display: flex;
			justify-content: space-between;
			margin-top: 10px;
		}
		#next-button, #end-button {
			width: calc(50% - 5px);
			height: 40px;
			padding: 10px;
			background-color: #4CAF50;
			color: white;
			border: none;
			border-radius: 5px;
			cursor: pointer;
			visibility: hidden;
			opacity: 0;
			transition: opacity 0.3s ease;
		}

		#next-button.visible, #end-button.visible {
			visibility: visible;
			opacity: 1;
		}



		#return-to-setup {
			display: block;
			margin-top: 20px;
			padding: 10px 20px;
			background-color: #4CAF50;
			color: white;
			border: none;
			border-radius: 5px;
			cursor: pointer;
		}
        .progress-container {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .close-button {
            margin-right: 40px;
            cursor: pointer;
            font-size: 20px;
        }

        .progress-bar {
            flex-grow: 1;
            height: 20px;
            background-color: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
        }
        .progress {
            height: 100%;
            background-color: orange;
            width: 0%;
            transition: width 0.3s ease;
        }
        .round-info {
            margin-left: 10px;
            font-weight: bold;
        }
        #character {
		font-size: 1.5em;
            transition: transform 0.3s ease;
        }
        #character.animated {
            transform: scale(1.5);
        }

		.result {
			display: none;
	  	    justify-content: center;
		    align-items: center;
			margin: 20px auto;
			max-width: 400px;
			padding: 20px;
			border-radius: 10px;

		}

		.result h2 {
			text-align: center;
			margin-bottom: 20px;
			color: #333;
		}

		.result p {
			margin: 10px 0;
			font-size: 16px;
			color: #555;
		}

		.accuracy-container {
		 text-align: center;
		}

		.accuracy-bar {
			flex-grow: 1;
			height: 20px;
			background-color: #e0e0e0;
			border-radius: 10px;
			margin-left: 10px;
			overflow: hidden;
		}

		#accuracy-progress {
			height: 100%;
			background-color: orange;
			width: 0%;
			transition: width 0.5s ease-in-out;
		}

		#return-to-setup {
			display: block;
			width: 100%;
			margin-top: 20px;
			padding: 10px;
			background-color: #4CAF50;
			color: white;
			border: none;
			border-radius: 5px;
			cursor: pointer;
			font-size: 16px;
			transition: background-color 0.3s;
		}

		#return-to-setup:hover {
			background-color: #45a049;
		}

		@media (max-width: 768px) {
			.right-item {
				margin-top: 10px;
				margin-bottom: 10px;
			}
		}

		@media (max-width: 768px) {
			.game {
				height: 90vh;
				overflow-y: auto;
				scrollbar-width: none;
				-ms-overflow-style: none;
			}

			.game::-webkit-scrollbar {
				display: none;
			}
		}

		@media (max-width: 768px) {
			.item-container {
				flex-direction: column;
				align-items: stretch;
			}

			#leftContainer {
				flex-direction: row;
				flex-wrap: wrap;
				justify-content: space-between;
			}

			#leftContainer .left-item {
				width: calc(50% - 10px);
				box-sizing: border-box;\				
			}

			#rightContainer .right-item {
				width: calc(100% - 30px);
				margin-bottom: 10px;
			}

			#next-button-container {
				flex-direction: row;
			}

			#next-button, #end-button {
				width: calc(50% - 5px);
			}


		}

		.sound-button {

			margin: 0px 5px;
			cursor: pointer;
			font-size: 20px;
		}

.idiom-list {
    background-color: white;
    padding: 10px 20px;
    border-radius: 10px;
    width: calc(100% - 40px);
    margin: 0 auto;
	height: 70vh;
    position: relative;
}

.idiom-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    position: relative;
}

.idiom-header h2 {
    margin: 0;
    flex-grow: 1;
    text-align: center;
}

.idiom-header .close-button {
    position: absolute;
    right: 0;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    font-size: 1.5em;
    cursor: pointer;
    padding: 0;
}

.list-close-button {
    background: none;
    border: none;
    font-size: 1.2em;
    cursor: pointer;
    padding: 0;
}

/* Á¢∫‰øùÂÖ∂‰ªñÈóúÈñâÊåâÈàï‰∏çÂèóÂΩ±Èüø */
.close-button:not(#close-idiom-list) {
    position: static;
    transform: none;
}





.close-button {
    background: none;
    border: none;
    font-size: 1.5em;
    cursor: pointer;
    color: #333;
}

.idiom-controls {
    margin-bottom: 10px;
}

.idiom-controls label {
    margin-right: 10px;
}




.idiom-table-container {
    overflow-x: auto;
    max-height: calc(80vh - 130px);
}

#idiom-table {
    width: 100%;
    border-collapse: collapse;
}

#idiom-table thead {
    position: sticky;
    top: 0;
	padding: 20px;
    background-color: #f2f2f2;
    z-index: 1;
}

#idiom-table th  {
    border: 1px solid #ddd;
    padding: 10px;
    text-align: center;
}

#idiom-table td {
    border: 1px solid #ddd;
    padding: 5px 5px 5px 10px;
    text-align: left;
}



.small-number{
    color: #ff5555;
	font-size: 0.4em;
}

.idiom {
    min-width: 130px;
	font-size: 1.1em;
	font-family: BpmfZihiSans-Regular;
}




#idiom-table th {
    background-color: #e1e1e1;
}

#idiom-table tbody tr:nth-child(odd) {
    background-color: #f8f8f8;
}

#idiom-table tbody tr:nth-child(even) {
    background-color: #fefefe;
}

@media (max-width: 768px) {
    .idiom-list {
        padding: 10px;
        max-height: 90vh;
    }

    .idiom-controls {
        display: flex;
        flex-wrap: wrap;
    }

    .idiom-controls label {
        margin-bottom: 10px;
    }

    #idiom-table {
        font-size: 14px;
    }
    
    #idiom-table th, #idiom-table td {
        padding: 5px;
    }
}

.nav-button {
    padding: 5px 10px;
    background-color: #4CAF50;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.3s;
}

.nav-button:hover {
    background-color: #45a049;
}

.nav-button:disabled {
    background-color: #cccccc;
    cursor: not-allowed;
}
.font-toggle-button {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    border: 1px solid #4CAF50;
    background-color: white;
    color: #4CAF50;
    font-size: 12px;
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    margin-right: 5px;
}

#clear-records {
    background-color: #f44336;
    color: white;
    border: none;
    padding: 5px 10px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    font-size: 12px;
    margin: 10px 5px 0 5px;
    cursor: pointer;
    border-radius: 50px;
    transition: background-color 0.3s;
}

#clear-records:hover {
    background-color: #d32f2f;
}

#clear-records:active {
    background-color: #b71c1c;
}

#clear-records:disabled {
    background-color: #cccccc;
    color: #666666;
    cursor: not-allowed;
}

.sorting-area {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin: 20px 0;
}

.answer-area {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    min-height: 65px;
    border-bottom: 2px solid #eee;
    width: 90%;
    padding: 10px;
    margin-bottom: 10px;
}


.character-options {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    margin-bottom: 10px;
}

.character-option, .in-answer {
    font-size: 1.5em;
    margin: 5px;
    padding: 8px;
    background-color: #f0f0f0;
    border: 1px solid #ccc;
    border-radius: 5px;
    cursor: pointer;
}

.check-button {
    margin-top: 10px;
    padding: 10px 20px;
    background-color: #4CAF50;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 1em;
}

.check-button:disabled {
	visibility: hidden;
}

.idiom-question {
    margin-bottom: 0px;
}


.character-option:hover, .in-answer:hover {
    background-color: #e0e0e0;
}



.in-answer {
    font-size: 1.5em;
    margin: 5px;
    padding: 10px;
    background-color: #e0f0e0;
    border: 1px solid #ccc;
    border-radius: 5px;
    cursor: pointer;
    display: inline-block;
}

        @keyframes jumpAnimation {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        @keyframes shakeAnimation {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-3px); }
            75% { transform: translateX(3px); }
        }

        .jump {
            animation: jumpAnimation 0.3s ease;
        }

        .shake {
            animation: shakeAnimation 0.3s ease;
        }


    </style>
</head>
<body>
    <div class="container">
		<div class="setup active" id="setup">
			<h1 id="myTitle">ü•∑ÁÉèË°£Ë°åÊàêË™û</h1>
			<div>
				<label for="category-select">ÂàÜÈ°ûÔºö</label>
				<select id="category-select">
					<option value="all">ÊâÄÊúâÂàÜÈ°û</option>
					<!-- ÂÖ∂‰ªñÂàÜÈ°ûÈÅ∏È†ÖÂ∞áÂú®ÈÄôË£°ÂãïÊÖãÁîüÊàê -->
				</select>
			</div>
			<div>
				<label for="match-type-select">ÈÖçÂ∞çÔºö</label>
				<select id="match-type-select">
					<option value="ÊàêË™û-Ë°®ÈÅîÊÑèÊÄù">ÊàêË™û - Ë°®ÈÅîÊÑèÊÄù</option>
					<option value="ÊàêË™û-Â≠óÈù¢ÊÑèÊÄù">ÊàêË™û - Â≠óÈù¢ÊÑèÊÄù</option>
					<option value="ÊàêË™û-‰æãÂè•">ÊàêË™û - ‰æãÂè•</option>
					<option value="ÊàêË™û-ÊéíÂ∫è">ÊàêË™û - ÊéíÂ∫è</option>
				</select>
			</div>
			<div>
				<label for="order-select">È†ÜÂ∫èÔºö</label>
				<select id="order-select">
					<option value="random">Èö®Ê©ü</option>
					<option value="sequential">‰æùÂ∫è</option>
				</select>
			</div>			
			<button id="view-idioms-button">Ê™¢Ë¶ñÊàêË™û üîé</button>
			<button id="start-button">ÈñãÂßãÈÅäÊà≤ üöÄ</button>
		</div>

		<div class="game" id="game">
			<div class="progress-container">
				<div class="close-button" id="close-button">‚úñÔ∏é</div>				
				<div class="progress-bar">
					<div class="progress" id="progress"></div>
				</div>
				<div class="round-info" id="round-info"></div>
				<div class="sound-button" id="sound-button">üîî</div>
				<div class="font-toggle-button" id="font-toggle-button">Â≠ó</div>
			</div>
			<h1><span id="character">üôÇ</span></h1>
			<div id="left-right-container">
				<div class="item-container" id="leftContainer"></div>
				<div class="item-container" id="rightContainer"></div>
			</div>
			<div id="sorting-container" style="display: none;">
				<div class="idiom-question" id="idiom-question"></div>
				<div class="sorting-area">
					<div id="answer-area" class="answer-area"></div>
					<div id="character-options" class="character-options"></div>
				</div>
				<button id="check-answer" class="check-button">Á¢∫ÂÆö</button>
			</div>
			<div id="next-button-container">                
				<button id="end-button">üéâ ÁµêÊùü</button>
				<button id="next-button">‰∏ã‰∏ÄÈ°å üöÄ</button>
			</div>
		</div>

		<div class="idiom-list" id="idiom-list" style="display: none;">
			<div class="idiom-header">
			<button id="close-idiom-list" class="list-close-button">‚úñÔ∏é</button><button id="prev-category" class="nav-button">‰∏ä‰∏ÄÂàÜÈ°û</button>
				<h2>ü•∑ÊàêË™û</h2>
				
				<button id="next-category" class="nav-button">‰∏ã‰∏ÄÂàÜÈ°û</button><div class="font-toggle-button" id="list-font-toggle-button">Â≠ó</div>
			</div>

			<div class="idiom-controls">
				<label><input type="checkbox" id="show-category" checked>ÂàÜÈ°û</label>
				<label><input type="checkbox" id="show-idiom" checked>ÊàêË™û</label>
				<label><input type="checkbox" id="show-literal" checked>Â≠óÈù¢</label>
				<label><input type="checkbox" id="show-figurative" checked>Áî®ÊÑè</label>
				<label><input type="checkbox" id="show-example">‰æãÂè•</label>
			</div>
			<div class="idiom-table-container">
				<table id="idiom-table">
					<thead>
						<tr>
							<th class="category">ÂàÜÈ°û</th>
							<th class="idiom">ÊàêË™û</th>
							<th class="literal">Â≠óÈù¢ÊÑèÊÄù</th>
							<th class="figurative">Ë°®ÈÅîÊÑèÊÄù</th>
							<th class="example">‰æãÂè•</th>
						</tr>
					</thead>
					<tbody>
						<!-- ÊàêË™ûË≥áÊñôÂ∞áÂú®ÈÄôË£°ÂãïÊÖãÁîüÊàê -->
					</tbody>
				</table>
			</div>
		</div>

		<div id="result" class="result">
			<h2>ü•∑ÁÉèË°£Ë°åÊàêË™û</h2>
		
				<div class="accuracy-bar">
					<div id="accuracy-progress"></div>
				</div>

			<div class="accuracy-container">		
				<p id="accuracy"></p>
				<p id="time-spent"></p>
				<p id="total-rounds"></p>
				<p id="total-pairs"></p>
				<p id="selected-category"></p>
				<p id="match-type-result"></p>
				<p id="order-type-result"></p>
			</div>
			<button id="clear-records" disabled>Ê∏ÖÈô§Á¥ÄÈåÑ üóëÔ∏è</button>
			<button id="return-to-setup">ËøîÂõû üõ∏</button>
		</div>

    </div>

    <script>
        const idiomsData = `
ÂàÜÈ°û	ÊàêË™û	Â≠óÈù¢ÊÑèÊÄù	Ë°®ÈÅîÊÑèÊÄù	‰æãÂè•	ÊãºÈü≥
A01	ËÄ≥ÊèêÈù¢ÂëΩ	Âú®ËÄ≥ÈÇäÊèêÈÜíÔºåÈù¢ÂâçÂèÆÂõëÔºåÊÇâÂøÉÊïôË™®„ÄÇ	ËÄêÂøÉÊåáÂ∞éÔºåË¶™Ëá™ÊïôË™®„ÄÇ	ËÄÅÂ∏´Â∞çÊàëÂÄëËÄ≥ÊèêÈù¢ÂëΩÔºåÊèêÈÜíÊàëÂÄëÁ¥∞ÁØÄ„ÄÇ|ËÄÅÂ∏´Â∞ç‰ªñËÄ≥ÊèêÈù¢ÂëΩÔºåÂèçË¶ÜÂèÆÂõë„ÄÇ	er3 ti2 mian4 ming4
A01	ÂÄüËä±Áçª‰Ωõ	ÂÄü‰ªñ‰∫∫‰πãÁâ©ÔºåÂêë‰ΩõÁçªÁ¶ÆÔºåÊØîÂñªÂÄüÁâ©ÈÄÅ‰∫∫„ÄÇ	Êãø‰ªñ‰∫∫Êù±Ë•øÂÅö‰∫∫ÊÉÖ„ÄÇ	ÈÄôÊùüËä±ÊòØÂÄüËä±Áçª‰ΩõÔºåÈÄÅÁµ¶ÊÇ®ÁöÑ„ÄÇ|‰ªñÁî®ÊúãÂèãÁöÑÈªûÂ≠êÂÄüËä±Áçª‰Ωõ„ÄÇ	jie4 hua1 xian4 fo2
A01	Á≤æË°õÂ°´Êµ∑	Á≤æË°õÈ≥•Â°´Êµ∑‰∏çÊáàÔºåÊØîÂñªÊÑèÂøóÂ†ÖÂº∑„ÄÇ	Ê±∫ÂøÉÂ†ÖÂÆöÔºå‰∏çÁïèËâ±Èõ£„ÄÇ	‰ªñÊØèÂ§©Âä™ÂäõÂ≠∏ÁøíÔºåÁúüÊúâÁ≤æË°õÂ°´Êµ∑ÁöÑÁ≤æÁ•û„ÄÇ|Â∞èÁæéÁÇ∫Â§¢ÊÉ≥Á≤æË°õÂ°´Êµ∑Ôºå‰∏çÁïèËâ±Èõ£„ÄÇ	jing1 wei4 tian2 hai3
A01	ËâØËó•Ëã¶Âè£	Â•ΩËó•ÈõñËã¶ÔºåÂçªËÉΩÊ≤ªÁóÖÔºåÊØîÂñªÂø†Ë®ÄÈÄÜËÄ≥„ÄÇ	Âø†Ë®ÄÂ§öÂçä‰∏ç‰∏≠ËÅΩ„ÄÇ	‰ªñÁöÑÂª∫Ë≠∞ÈõñÁÑ∂Âà∫ËÄ≥Ôºå‰ΩÜËâØËó•Ëã¶Âè£„ÄÇ|‰ªñÁöÑÊâπË©ïÈõñÁÑ∂Âà∫ËÄ≥Ôºå‰ΩÜËâØËó•Ëã¶Âè£„ÄÇ	liang2 yao4 ku3 kou3
A01	Â§©ÁøªÂú∞Ë¶Ü	Â§©Âú∞È°õÂÄíÔºåÊØîÂñªËÆäÂåñÂäáÁÉà„ÄÇ	ËÆäÂåñÂ∑®Â§ßÔºåÂÆåÂÖ®‰∏çÂêå„ÄÇ	Á∂ìÈÅéÊîπÈù©ÔºåÂÖ¨Âè∏ÁöÑÈù¢Ë≤åÂ§©ÁøªÂú∞Ë¶Ü„ÄÇ|ÁßëÊäÄÈÄ≤Ê≠•ËÆìÁîüÊ¥ªÂ§©ÁøªÂú∞Ë¶Ü„ÄÇ	tian1 fan1 di4 fu4
A01	ÊâìÈÄÄÂ†ÇÈºì	Âú®ÈÄÄÂ†ÇÊôÇÊï≤ÈºìÔºåÊØîÂñª‰∏≠ÈÄîÈÄÄÁ∏Æ„ÄÇ	‰∏≠ÈÄîÈÄÄÁ∏ÆÔºå‰∏çÂÜçÂ†ÖÊåÅ„ÄÇ	ÈÅáÂà∞Âõ∞Èõ£Â∞±ÊÉ≥ÊâìÈÄÄÂ†ÇÈºìÔºåÊÄéÈ∫ºË°åÂë¢Ôºü|ÈÅáÂà∞Âõ∞Èõ£Ôºå‰ªñÂ∑ÆÈªûÊâìÈÄÄÂ†ÇÈºì„ÄÇ	da3 tui4 tang2 gu3
A01	ÁøªÂ±±Ë∂äÂ∂∫	Ë∂äÈÅéÂ±±Â∂∫ÔºåÊØîÂñªÊ≠∑Á∂ìËâ±Èõ£„ÄÇ	ÂÖãÊúçÂõ∞Èõ£ÔºåÂä™ÂäõÂâçÈÄ≤„ÄÇ	‰ªñÁøªÂ±±Ë∂äÂ∂∫ÔºåÁµÇÊñºÊâæÂà∞ÈÇ£‰ΩçËÄÅÂ∏´„ÄÇ|‰ªñÂÄëÁøªÂ±±Ë∂äÂ∂∫ÔºåÂè™ÁÇ∫ÁúãÊó•Âá∫„ÄÇ	fan1 shan1 yue4 ling3
A01	Êä´ÊòüÊà¥Êúà	È†ÇÊòüÊòüÔºåÂ∏∂Êúà‰∫ÆÔºåÊØîÂñªÈÄ£Â§úÂ•îÊ≥¢„ÄÇ	Êó©Âá∫ÊôöÊ≠∏ÔºåÂã§Â•ÆÂãû‰Ωú„ÄÇ	‰ªñÊØèÂ§©Êä´ÊòüÊà¥ÊúàÔºåÁÇ∫‰∫ÜÂÆ∂‰∫∫Âä™ÂäõÂ∑•‰Ωú„ÄÇ|Áà∏Áà∏ÊØèÂ§©Êä´ÊòüÊà¥ÊúàÂú∞Â∑•‰Ωú„ÄÇ	pi1 xing1 dai4 yue4
A02	Êá∏Â¥ñÂãíÈ¶¨	Âà∞‰∫ÜÊá∏Â¥ñÔºåÂãí‰ΩèÈ¶¨ÔºåÂç≥ÊôÇÂÅúÊ≠¢„ÄÇ	ÂèäÊôÇÂõûÈ†≠ÔºåÈÅøÂÖçÂç±Èö™„ÄÇ	‰ªñÂú®ÈåØË™§ÈÇäÁ∑£Êá∏Â¥ñÂãíÈ¶¨ÔºåÂèäÊôÇÂõûÈ†≠„ÄÇ|Âú®ÊúÄÂç±Èö™ÁöÑÊôÇÂÄôÔºå‰ªñÊá∏Â¥ñÂãíÈ¶¨„ÄÇ	xuan2 ya2 le4 ma3
A02	ÂÖ¢ÂÖ¢Ê•≠Ê•≠	Â∞èÂøÉË¨πÊÖéÔºåË™çÁúüË≤†Ë≤¨„ÄÇ	Â∞èÂøÉË¨πÊÖéÔºåË™çÁúüË≤†Ë≤¨„ÄÇ	‰ªñÂÖ¢ÂÖ¢Ê•≠Ê•≠Âú∞ÂÆåÊàêÊØè‰∏ÄÈ†ÖÂ∑•‰Ωú„ÄÇ|‰ªñÂ∞çÂ∑•‰ΩúÁ∏ΩÊòØÂÖ¢ÂÖ¢Ê•≠Ê•≠„ÄÇ	jing1 jing1 ye4 ye4
A02	ÈõûÁä¨‰∏çÂØß	ÈÄ£ÈõûÁä¨‰πü‰∏çÂæóÂÆâÂØßÔºåÊØîÂñªÈ®∑‰∫Ç‰∏çÂÆâ„ÄÇ	Ê∑∑‰∫Ç‰∏çÂÆâÔºåÁÑ°Ê≥ïÂÆâÈùú„ÄÇ	ÊúÄËøëÁöÑÂ∑•Á®ãËÆìÈÑ∞Â±ÖÂÄëÈõûÁä¨‰∏çÂØß„ÄÇ|Â∞èÂ≠©È¨ßÈ®∞ÂæóÂÆ∂Ë£°ÈõûÁä¨‰∏çÂØß„ÄÇ	ji1 quan3 bu4 ning2
A02	‰∏ÄË¶ñÂêå‰ªÅ	ÂêåÊ®£ÁúãÂæÖ‰ªñ‰∫∫Ôºå‰∏çÂàÜÂéöËñÑ„ÄÇ	‰∏çÂàÜÂéöËñÑÔºåÂπ≥Á≠âÂ∞çÂæÖ„ÄÇ	ËÄÅÂ∏´Â∞çÊâÄÊúâÂ≠∏Áîü‰∏ÄË¶ñÂêå‰ªÅÔºå‰∏çÂÅè‰∏çÂÄö„ÄÇ|ËÄÅÂ∏´Â∞çÊØè‰ΩçÂ≠∏Áîü‰∏ÄË¶ñÂêå‰ªÅ„ÄÇ	yi1 shi4 tong2 ren2
A02	Â≠§Ê≥®‰∏ÄÊì≤	ÊäïÂÖ•ÂÖ®ÈÉ®Ë≥≠Ê≥®ÔºåÊØîÂñªÂ≠§ÂãáÂÜíÈö™„ÄÇ	ÂÜíÈö™‰∏ÄÊêèÔºå‰∏çÁïôÈÄÄË∑Ø„ÄÇ	‰ªñÂ∞áÂÖ®ÈÉ®Ë≥áÈáëÂ≠§Ê≥®‰∏ÄÊì≤ÔºåÊäïË≥áÈÄôÈ†ÖË®àÁï´„ÄÇ|‰ªñÁÇ∫‰∫ÜÊàêÂäüÂ≠§Ê≥®‰∏ÄÊì≤„ÄÇ	gu1 zhu4 yi1 zhi4
A02	Áõ°ÂñÑÁõ°Áæé	‰∏ÄÂàáÂÆåÁæéÁÑ°Áº∫ÔºåÊ•µËá¥ÂÆåÁæé„ÄÇ	ÂÆåÁæéÁÑ°ÁëïÔºåÁÑ°ÂèØÊåëÂâî„ÄÇ	‰ªñÊääÈÄôÊ¨°‰ΩúÂìÅÂÅöÂà∞Áõ°ÂñÑÁõ°Áæé„ÄÇ|‰ªñËøΩÊ±ÇÊää‰ΩúÂìÅÂÅöÂæóÁõ°ÂñÑÁõ°Áæé„ÄÇ	jin4 shan4 jin4 mei3
A02	ÁßÄÂ§ñÊÖß‰∏≠	Â§ñË°®ÁßÄÈ∫óÔºåÂÖßÂøÉÊô∫ÊÖß„ÄÇ	Â§ñË°®ÁßÄÈ∫óÔºåÂÖßÂøÉËÅ∞ÊÖß„ÄÇ	Â•π‰∏çÂÉÖÊºÇ‰∫ÆÔºåÈÇÑÁßÄÂ§ñÊÖß‰∏≠„ÄÇ|Â•π‰∏çÂÉÖÊºÇ‰∫ÆÔºåÊõ¥ÊòØÁßÄÂ§ñÊÖß‰∏≠„ÄÇ	xiu4 wai4 hui4 zhong1
A02	Ë±ÅÁÑ∂ÈñãÊúó	Ë±ÅÁÑ∂ÊòéÊúóÔºåÊØîÂñªÂøΩÁÑ∂ÊòéÁôΩ„ÄÇ	ÂøÉÂ¢ÉÈ†ìÊÇüÔºåËåÖÂ°ûÈ†ìÈñã„ÄÇ	‰ªñËÅΩÂÆåÂª∫Ë≠∞ÂæåÔºåÂøÉ‰∏≠Ë±ÅÁÑ∂ÈñãÊúó„ÄÇ|Á∂ìÈÅéÊåáÈªûÔºå‰ªñÈ†ìÊôÇË±ÅÁÑ∂ÈñãÊúó„ÄÇ	huo4 ran2 kai1 lang3
A02	ÁôªÂ≥∞ÈÄ†Ê•µ	Áôª‰∏äÈ´òÂ≥∞ÔºåÊØîÂñªÈÅîÂà∞Ê•µËá¥„ÄÇ	ÈÅîÂà∞ÊúÄÈ´òÂ¢ÉÁïå„ÄÇ	‰ªñÁöÑËóùË°ìÊàêÂ∞±Â∑≤Á∂ìÁôªÂ≥∞ÈÄ†Ê•µ„ÄÇ|‰ªñÁöÑÊäÄË°ìÂ∑≤ÈÅîÁôªÂ≥∞ÈÄ†Ê•µÁöÑÂ¢ÉÁïå„ÄÇ	deng1 feng1 zao4 ji2
A02	ËôõÊá∑Ëã•Ë∞∑	ËÉ∏Êá∑Â¶ÇË∞∑Âú∞Ëà¨ÂØ¨ÈóäÔºåÊØîÂñªË¨ôËôõ„ÄÇ	Ë¨ôËôõË¨πÊÖéÔºåËôõÂøÉÂ≠∏Áøí„ÄÇ	‰ªñÂæÖ‰∫∫ËôõÊá∑Ëã•Ë∞∑ÔºåÂçÅÂàÜË¨ôËôõ„ÄÇ|‰ªñÁÇ∫‰∫∫Ë¨ôÈÅúÔºåËôõÊá∑Ëã•Ë∞∑„ÄÇ	xu1 huai2 ruo4 gu3
A02	‰∏çÂêåÂá°Èüø	ËÅ≤Èü≥‰∏çÂêåÂ∏∏‰∫∫ÔºåÊØîÂñªÂçìË∂äÂá∫Áúæ„ÄÇ	Âá∫ÁúæÈùûÂá°ÔºåËàáÁúæ‰∏çÂêå„ÄÇ	Â•πÁöÑÊºîË¨õÁúüÊòØ‰∏çÂêåÂá°ÈüøÔºåÊâìÂãï‰∫∫ÂøÉ„ÄÇ|Â•πÁöÑË°®ÊºîÁ¢∫ÂØ¶‰∏çÂêåÂá°Èüø„ÄÇ	bu4 tong2 fan2 xiang3
A02	ÂçÉËÆäËê¨Âåñ	ÂçÉËê¨Á®ÆËÆäÂåñÔºåÂΩ¢ÂÆπËÆäÂåñÂ§öÁ´Ø„ÄÇ	ËÆäÂåñÂ§öÁ´ØÔºåÁÑ°Ê≥ïÈ†êÊ∏¨„ÄÇ	Â§©Á©∫ÁöÑÈõ≤Â±§ÂçÉËÆäËê¨ÂåñÔºåÁæé‰∏çÂãùÊî∂„ÄÇ|ÊôÇÂ∞öÁöÑÊµÅË°åÈ¢®Ê†ºÂçÉËÆäËê¨Âåñ„ÄÇ	qian1 bian4 wan4 hua4
A02	‰∏çÁü•‰∏çË¶∫	ÁÑ°Ëá™Ë¶∫Âú∞ÁôºÁîüÊàñÁôºÁèæ„ÄÇ	ÁÑ°ÊÑèÈñìÔºå‰∏çÁü•‰∏çË¶∫‰∏≠„ÄÇ	‰∏çÁü•‰∏çË¶∫‰∏≠ÔºåÊôÇÈñìÂ∑≤Á∂ìÈÅéÂéª‰∏ÄÊï¥Â§©„ÄÇ|ËÅäËëóËÅäËëóÔºå‰∏çÁü•‰∏çË¶∫Â§©‰∫Æ‰∫Ü„ÄÇ	bu4 zhi1 bu4 jue2
A02	‰∏çÁü•ÊâÄÊé™	‰∏çÁü•Â¶Ç‰ΩïÊáâÂ∞çÔºåÂΩ¢ÂÆπÊÖåÂºµ„ÄÇ	È©öÊÖåÂ§±Êé™ÔºåÁÑ°Ê≥ïÊáâÂ∞ç„ÄÇ	ËÅΩÂà∞ÈÄôÊ∂àÊÅØÔºå‰ªñ‰∏ÄÊôÇ‰∏çÁü•ÊâÄÊé™„ÄÇ|Á™ÅÂ¶ÇÂÖ∂‰æÜÁöÑËÆäÊïÖËÆì‰ªñ‰∏çÁü•ÊâÄÊé™„ÄÇ	bu4 zhi1 suo3 cuo4
`;



const dictMap = new Map(dictData.trim().split('\n').map(line => {
    const [pinyin, chars] = line.split('\t');
	const charsSplit = Array.from(chars);
    return [pinyin, charsSplit];
}));

function getPinyinArray(pinyinString) {
    return pinyinString.split(/ +/);
}

function getRandomCharForPinyin(pinyin, excludeChars) {
    const chars = dictMap.get(pinyin) || [];
    const availableChars = chars.filter(char => !excludeChars.includes(char));
    return availableChars[Math.floor(Math.random() * availableChars.length)];
}


function removeBPMCharacters(str) {
    return str.replace(/[Û†á†Û†á°Û†á¢Û†á£Û†á§Û†á•Û†á¶Û†áßÛ†á®Û†á©]/gu, '');
}

const idioms = idiomsData.trim().split('\n').slice(1).map(line => {
    const [ÂàÜÈ°û, ÊàêË™û, Â≠óÈù¢ÊÑèÊÄù, Ë°®ÈÅîÊÑèÊÄù, ‰æãÂè•, ÊãºÈü≥] = line.split('\t');
    const idiomNoBPM = removeBPMCharacters(ÊàêË™û);
    return { ÂàÜÈ°û, ÊàêË™û, idiomNoBPM, Â≠óÈù¢ÊÑèÊÄù, Ë°®ÈÅîÊÑèÊÄù, ‰æãÂè•, ÊãºÈü≥ };
});

        const categories = [...new Set(idioms.map(idiom => idiom.ÂàÜÈ°û))];
        const categorySelect = document.getElementById('category-select');
        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            categorySelect.appendChild(option);
        });

let currentIdioms = [];
let selectedLeft = null;
let selectedRight = null;
let matchType = 'ÊàêË™û-Ë°®ÈÅîÊÑèÊÄù';
// const matchType = document.getElementById('match-type-select').value;
let currentIndex = 0;
let orderedIdioms = [];
let totalRounds = 0;
let currentRound = 0;
const idiomsPerRound = 4;
let startTime;
let correctPairs = 0;
let totalPairs = 0;
let isSoundOn = true;
let currentCategoryIndex = 0;
let currentFont = 'BpmfZihiSans-Regular';
let currentFontState = 'zih';
let currentFontSize = '1.3em';
const idiomLocalName = "j01";

const happyEmojis = "ü•∞üòõü§óüòÑüòçü§©üòòüòöüòãüòäüòÜüòÅüòÑüòÉ";
const sadEmojis = "üòüüòÆü•∫üòßüò®üò•üò¢üò≠üò±üòñüò©üò§";

const rightAudio = new Audio('right.mp3');
const wrongAudio = new Audio('wrong.mp3');

function playAudio(audio) {
    if (isSoundOn) {
        audio.currentTime = 0;
        audio.play();
    }
}

// Âæû localStorage ËÆÄÂèñÈåØË™§Ë®òÈåÑ
function getErrorRecords() {
    const records = localStorage.getItem(`${idiomLocalName}_errorRecords`);
    return records ? JSON.parse(records) : {};
}

// ‰øùÂ≠òÈåØË™§Ë®òÈåÑÂà∞ localStorage
function saveErrorRecords(records) {
    localStorage.setItem(`${idiomLocalName}_errorRecords`, JSON.stringify(records));
}

// Êõ¥Êñ∞ÈåØË™§Ë®òÈåÑ
function updateErrorRecord(idiom) {
    const records = getErrorRecords();
    records[idiom] = (records[idiom] || 0) + 1;
    saveErrorRecords(records);
}

// Ê∏ÖÈô§ÈåØË™§Ë®òÈåÑ
function clearErrorRecords() {
    localStorage.removeItem(`${idiomLocalName}_errorRecords`);
}

document.getElementById('sound-button').onclick = toggleSound;

function toggleFont() {
    const fontToggleButton = document.getElementById('font-toggle-button');
	const ListfontToggleButton = document.getElementById('list-font-toggle-button');

    const leftItems = document.querySelectorAll('.left-item');
	const idioms = document.querySelectorAll('.idiom');

    switch(currentFontState) {
        case 'zih':
            currentFontState = 'box';
            fontToggleButton.textContent = 'Ê°Ü';
			ListfontToggleButton.textContent = 'Ê°Ü';
			currentFont = 'BpmfZihiBox-R';
			currentFontSize = '1.4em';

			leftItems.forEach(item => {
				item.style.fontFamily = 'BpmfZihiBox-R';
				item.style.fontSize = '1.4em';
			});
			idioms.forEach(item => {
				item.style.fontFamily = 'BpmfZihiBox-R';
				item.style.fontSize = '1.4em';
				item.style.minWidth = '160px';
			});
            break;
        case 'box':
            currentFontState = 'bpmf';
            fontToggleButton.textContent = 'Èü≥';
			ListfontToggleButton.textContent = 'Èü≥';
			currentFont = 'BpmfZihiOnly-R';
			currentFontSize = '2em';

			leftItems.forEach(item => {
				item.style.fontFamily = 'BpmfZihiOnly-R';
				item.style.fontSize = '2em';
			}); 
			idioms.forEach(item => {
				item.style.fontFamily = 'BpmfZihiOnly-R';
				item.style.fontSize = '1.6em';
				item.style.minWidth = '120px';
			}); 
            break;
        case 'bpmf':
            currentFontState = 'zih';
            fontToggleButton.textContent = 'Â≠ó';
			ListfontToggleButton.textContent = 'Â≠ó';
			currentFont = 'BpmfZihiSans-Regular';
			currentFontSize = '1.3em';

			leftItems.forEach(item => {
				item.style.fontFamily = 'BpmfZihiSans-Regular';
				item.style.fontSize = '1.3em';
			}); 
			idioms.forEach(item => {
				item.style.fontFamily = 'BpmfZihiSans-Regular';
				item.style.fontSize = '1em';
				item.style.minWidth = '120px';

			}); 
            break;
    }
}

function toggleSound() {
    isSoundOn = !isSoundOn;
    const soundButton = document.getElementById('sound-button');
    soundButton.textContent = isSoundOn ? 'üîî' : 'üîï';
}

function showEndButton() {
    const endButton = document.getElementById('end-button');
    endButton.classList.add('visible');
}

function hideEndButton() {
    const endButton = document.getElementById('end-button');
	endButton.blur();
    endButton.classList.remove('visible');
}

function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
}

        function selectItem(item, side) {
            if (side === 'left') {
                if (selectedLeft) {
                    selectedLeft.classList.remove('selected');
                }
                selectedLeft = item;
            } else {
                if (selectedRight) {
                    selectedRight.classList.remove('selected');
                }
                selectedRight = item;
            }
            item.classList.add('selected');

            if (selectedLeft && selectedRight) {
                checkMatch();
            }
        }

	function stringToArray(str) {
		return Array.from(str.match(/\P{RI}\p{RI}?\p{RI}?/gu) ?? []);
	}

	function getRandomEmoji(emojiString) {
		const emojiArray = stringToArray(emojiString);
		return emojiArray[Math.floor(Math.random() * emojiArray.length)];
	}

	function changeEmoji(isCorrect) {
		const character = document.getElementById('character');
		if (isCorrect) {
			character.textContent = getRandomEmoji(happyEmojis);
			character.classList.add('animated');

			/*
			setTimeout(() => {
				character.textContent = 'üôÇ';
				character.classList.remove('animated');
			}, 2000);
			*/
		} else {
			character.textContent = getRandomEmoji(sadEmojis);
			character.classList.add('animated');
		}
	}



    function checkMatch() {
        const leftText = selectedLeft.textContent;
        const rightText = selectedRight.textContent;
        const correctPair = currentIdioms.find(pair => pair.left === leftText && pair.right === rightText);
		const leftItems = document.querySelectorAll('.left-item');
		const nextButton = document.getElementById('next-button');
		const endButton = document.getElementById('end-button');

        if (correctPair) {
			correctPairs++;
			playAudio(rightAudio);
            
            
			selectedLeft.classList.add('jump');
			setTimeout(() => {
				selectedLeft.classList.remove('jump');
				selectedLeft.style.backgroundColor = '#4CAF50';				
			}, 500);

			selectedRight.classList.add('jump');
			setTimeout(() => {
				selectedRight.classList.remove('jump');
				selectedRight.style.backgroundColor = '#4CAF50';				
			}, 500);

            selectedLeft.style.pointerEvents = 'none';
            selectedRight.style.pointerEvents = 'none';
			selectedLeft.classList.add('correct');
			selectedRight.classList.add('correct');
            selectedLeft = null;
            selectedRight = null;
            changeEmoji(true);

            if (document.querySelectorAll('.left-item:not([style*="pointer-events: none"])').length === 0) {
    			leftItems.forEach(item => {
					item.style.fontFamily = 'BpmfZihiSans-Regular';
					item.style.fontSize = '1.3em';
				});  
				if(currentRound >= totalRounds){
					showEndButton();
					endButton.focus();									
				} else {
					showNextButton();
					showEndButton();
					nextButton.focus();
				}
            }
        } else {
			playAudio(wrongAudio);
			changeEmoji(false);
			updateErrorRecord(selectedLeft.textContent);



			selectedLeft.classList.add('shake');
			selectedLeft.classList.add('selected-wrong');
			selectedLeft.classList.remove('selected');
			setTimeout(() => {
				selectedLeft.classList.remove('shake');	
				selectedLeft.classList.remove('selected-wrong');
				selectedLeft = null;
			}, 500);

			selectedRight.classList.add('shake');
			selectedRight.classList.add('selected-wrong');
			selectedRight.classList.remove('selected');
			setTimeout(() => {
				selectedRight.classList.remove('shake');	
				selectedRight.classList.remove('selected-wrong');
				selectedRight = null;
			}, 500);
		}
		totalPairs++;
    }



function showResult() {
    const endTime = new Date();
    const timeSpent = Math.round((endTime - startTime) / 1000);
    const accuracy = Math.round((correctPairs / totalPairs) * 100);

    document.getElementById('accuracy-progress').style.width = `${accuracy}%`;

    document.getElementById('accuracy').textContent = `‚ú®Ê≠£Á¢∫Ôºö${accuracy}%`;
    document.getElementById('total-rounds').textContent = `üé°ÂõûÂêàÔºö${currentRound}`;
    document.getElementById('time-spent').textContent = `‚è∞Âä™ÂäõÔºö${timeSpent} Áßí`;
    document.getElementById('selected-category').textContent = `üìíÂàÜÈ°ûÔºö${categorySelect.options[categorySelect.selectedIndex].text}`;
    document.getElementById('match-type-result').textContent = `ü™ßÈÖçÂ∞çÔºö${document.getElementById('match-type-select').options[document.getElementById('match-type-select').selectedIndex].text}`;
    
    const orderSelect = document.getElementById('order-select');
    const orderText = orderSelect.options[orderSelect.selectedIndex].text;
    document.getElementById('order-type-result').textContent = `üè∑Ô∏èÈ†ÜÂ∫èÔºö${orderText}`;

    updateClearRecordsButton();

    document.getElementById('game').style.display = 'none';
    document.getElementById('result').style.display = 'block';
}

document.getElementById('end-button').onclick = function() {
    showResult();
};

document.getElementById('return-to-setup').onclick = function() {
    document.getElementById('result').style.display = 'none';
	initializeCategories();
	resetGame();	
};

        function showNextButton() {
            const nextButton = document.getElementById('next-button');		
            nextButton.classList.add('visible');
        }

        function hideNextButton() {
            const nextButton = document.getElementById('next-button');
			nextButton.blur();
            nextButton.classList.remove('visible');
        }

function getOrderedIdioms() {
    const selectedCategory = categorySelect.value;
    let filteredIdioms;

    if (selectedCategory === 'Â∏∏ÈåØÊåëÊà∞') {
        const errorRecords = getErrorRecords();
        filteredIdioms = idioms.filter(idiom => errorRecords.hasOwnProperty(idiom.ÊàêË™û));
        
        if (document.getElementById('order-select').value === 'sequential') {
            filteredIdioms.sort((a, b) => errorRecords[b.ÊàêË™û] - errorRecords[a.ÊàêË™û]);
        }
    } else {
        filteredIdioms = selectedCategory === 'all' ? 
            idioms.slice() : idioms.filter(idiom => idiom.ÂàÜÈ°û === selectedCategory);
    }

    return filteredIdioms;
}


function updateProgress() {
    const progress = document.getElementById('progress');
    const roundInfo = document.getElementById('round-info');
    progress.style.width = `${(currentRound / totalRounds) * 100}%`;
    roundInfo.textContent = `${currentRound}/${totalRounds}`;
}

function resetGame() {
    currentIndex = 0;
    currentRound = 0;
    orderedIdioms = [];
    correctPairs = 0;
    totalPairs = 0;
    hideEndButton();
    hideNextButton();
    document.getElementById('setup').classList.add('active');
    document.getElementById('setup').style.display = 'block';
    document.getElementById('game').classList.remove('active');
    document.getElementById('game').style.display = 'none';
	
}

function getRandomExample(examples) {
    const exampleArray = examples.split('|');
    return exampleArray[Math.floor(Math.random() * exampleArray.length)].trim();
}

// Âá∫È°å;

function startNewRound() {
    const selectedCategory = categorySelect.value;
    const orderType = document.getElementById('order-select').value;

    const nextButton = document.getElementById('next-button');
    const endButton = document.getElementById('end-button');
    nextButton.blur();
    endButton.blur();

    if (currentIndex === 0 || currentIndex >= orderedIdioms.length) {
        orderedIdioms = getOrderedIdioms();
        if (orderType === 'random' || (selectedCategory === 'Â∏∏ÈåØÊåëÊà∞' && orderType === 'sequential')) {
            shuffleArray(orderedIdioms);
        }
        currentIndex = 0;
        // Ê†πÊìöÈÅäÊà≤Ê®°ÂºèË®≠ÁΩÆ totalRounds
        if (matchType === 'ÊàêË™û-ÊéíÂ∫è') {
            totalRounds = orderedIdioms.length;  // ÊéíÂ∫èÊ®°Âºè‰∏ãÔºåÊØèÂÄãÊàêË™ûÈÉΩÊòØ‰∏ÄÂÄãÂõûÂêà
        } else {
            totalRounds = Math.ceil(orderedIdioms.length / idiomsPerRound);
        }
        
        currentRound = 0;
    }

    currentRound++;
    updateProgress();

    if (matchType === 'ÊàêË™û-ÊéíÂ∫è') {
        const idiom = orderedIdioms[currentIndex];
        setupSortingGame(idiom);
        currentIndex++;
    } else {
        // È°ØÁ§∫Â∑¶Âè≥ÈÖçÂ∞çÂÆπÂô®ÔºåÈö±ËóèÊéíÂ∫èÂÆπÂô®
        document.getElementById('left-right-container').style.display = 'block';
        document.getElementById('sorting-container').style.display = 'none';
        currentIdioms = [];
        for (let i = 0; i < idiomsPerRound && currentIndex < orderedIdioms.length; i++) {
            const idiom = orderedIdioms[currentIndex];
            let pair;
            switch (matchType) {
                case 'ÊàêË™û-Ë°®ÈÅîÊÑèÊÄù':
                    pair = { left: idiom.ÊàêË™û, right: idiom.Ë°®ÈÅîÊÑèÊÄù };
                    break;
                case 'ÊàêË™û-Â≠óÈù¢ÊÑèÊÄù':
                    pair = { left: idiom.ÊàêË™û, right: idiom.Â≠óÈù¢ÊÑèÊÄù };
                    break;
                case 'ÊàêË™û-‰æãÂè•':
                    const randomExample = getRandomExample(idiom.‰æãÂè•);
                    const maskedSentence = randomExample.replace(idiom.idiomNoBPM, 'üôà');
                    pair = { left: idiom.ÊàêË™û, right: maskedSentence };
                    break;
            }
            currentIdioms.push(pair);
            currentIndex++;
        }

        const leftContainer = document.getElementById('leftContainer');
        const rightContainer = document.getElementById('rightContainer');

        leftContainer.innerHTML = '';
        rightContainer.innerHTML = '';

        // ÂâµÂª∫Â∑¶ÂÅ¥ÈÅ∏È†Ö
        const leftItems = currentIdioms.map(pair => pair.left);

        leftItems.forEach(item => {
            const leftElement = document.createElement('div');
            leftElement.className = 'left-item';
            leftElement.style.fontFamily = currentFont;
            leftElement.style.fontSize = currentFontSize;        
            leftElement.textContent = item;
            leftElement.onclick = () => selectItem(leftElement, 'left');
            leftContainer.appendChild(leftElement);
        });

        // ÂâµÂª∫Âè≥ÂÅ¥ÈÅ∏È†ÖÔºàÂßãÁµÇÈö®Ê©üÊéíÂ∫èÔºâ
        const rightItems = currentIdioms.map(pair => pair.right);
        shuffleArray(rightItems);
        rightItems.forEach(item => {
            const rightElement = document.createElement('div');
            rightElement.className = 'right-item';
            rightElement.textContent = item;
            rightElement.onclick = () => selectItem(rightElement, 'right');
            rightContainer.appendChild(rightElement);
        });
    }

    if (currentRound === 1) {
        startTime = new Date();
    }
}



function setupSortingGame(idiom) {
    const pinyinArray = getPinyinArray(idiom.ÊãºÈü≥);
    const correctChars = Array.from(idiom.idiomNoBPM);
    const wrongChars = pinyinArray.map(pinyin => 
        getRandomCharForPinyin(pinyin, correctChars)
    ).filter(char => char); // ÈÅéÊøæÊéâÂèØËÉΩÁöÑ undefined

	//here

    const allChars = [...correctChars, ...wrongChars];
    shuffleArray(allChars);

    // Èö±ËóèÂ∑¶Âè≥ÈÖçÂ∞çÂÆπÂô®ÔºåÈ°ØÁ§∫ÊéíÂ∫èÂÆπÂô®
    document.getElementById('left-right-container').style.display = 'none';
    document.getElementById('sorting-container').style.display = 'block';

    // Êõ¥Êñ∞ÊàêË™ûÂïèÈ°å
    const idiomQuestion = document.getElementById('idiom-question');
    idiomQuestion.textContent = idiom.ÊàêË™û;
    idiomQuestion.style.fontFamily = 'BpmfZihiOnly-R';
    idiomQuestion.style.fontSize = '3em';

    // Ê∏ÖÁ©∫‰∏¶Â°´ÂÖÖÁ≠îÊ°àÂçÄÂíåÈÅ∏È†ÖÂçÄ
    const answerArea = document.getElementById('answer-area');
    const characterOptions = document.getElementById('character-options');
    answerArea.innerHTML = '';
    characterOptions.innerHTML = '';

    allChars.forEach(char => {
        const charElement = document.createElement('div');
        charElement.className = 'character-option';
        charElement.textContent = char;
        characterOptions.appendChild(charElement);
    });

    setupClickHandlers();

    // ÈáçÊñ∞Á∂ÅÂÆöÁ¢∫ÂÆöÊåâÈàïÁöÑ‰∫ã‰ª∂
    const checkButton = document.getElementById('check-answer');
    checkButton.onclick = () => checkSortingAnswer(idiom);
    checkButton.disabled = true; // ÂàùÂßãÊôÇÁ¶ÅÁî®Á¢∫ÂÆöÊåâÈàï
}

function setupClickHandlers() {
    const answerArea = document.getElementById('answer-area');
    const characterOptions = document.getElementById('character-options');
    
    // ÁßªÈô§ËàäÁöÑ‰∫ã‰ª∂Áõ£ËÅΩÂô®
    characterOptions.removeEventListener('click', handleCharacterOptionClick);
    answerArea.removeEventListener('click', handleAnswerAreaClick);

    // ‰ΩøÁî®‰∫ã‰ª∂ÂßîÊ¥æ
    characterOptions.addEventListener('click', handleCharacterOptionClick);
    answerArea.addEventListener('click', handleAnswerAreaClick);
}

function handleCharacterOptionClick(e) {
    if (e.target.classList.contains('character-option')) {
        const charElement = e.target.cloneNode(true);
        charElement.classList.add('in-answer');
        document.getElementById('answer-area').appendChild(charElement);
        e.target.style.display = 'none';
		updateCheckButtonState();
    }
}

function handleAnswerAreaClick(e) {
    if (e.target.classList.contains('in-answer')) {
        const char = e.target.textContent;
        const originalOption = Array.from(document.getElementById('character-options').children)
            .find(el => el.textContent === char && el.style.display === 'none');
        if (originalOption) {
            originalOption.style.display = '';
        }
        e.target.remove();
		updateCheckButtonState();
    }
}

function updateCheckButtonState() {
    const answerArea = document.getElementById('answer-area');
    const checkButton = document.getElementById('check-answer');
    const currentIdiom = orderedIdioms[currentIndex - 1];
    checkButton.disabled = answerArea.children.length !== currentIdiom.idiomNoBPM.length;
}
	

function checkSortingAnswer(idiom) {
    const answerArea = document.getElementById('answer-area');
    const characterOptions = document.getElementById('character-options');
    const checkButton = document.getElementById('check-answer');
    const userAnswer = Array.from(answerArea.children).map(el => el.textContent).join('');
    const nextButton = document.getElementById('next-button');
    const endButton = document.getElementById('end-button');

    if (userAnswer === idiom.idiomNoBPM) {
        // Á≠îÊ°àÊ≠£Á¢∫
        answerArea.classList.add('jump');
        setTimeout(() => {
            answerArea.classList.remove('jump');
        }, 500);
        playAudio(rightAudio);
        changeEmoji(true);
        correctPairs++;
        if (currentRound >= totalRounds) {
            showEndButton();
            endButton.focus();                                  
        } else {
            showNextButton();
            showEndButton();
            nextButton.focus();
        }
        checkButton.disabled = true; // Á¶ÅÁî®Á¢∫ÂÆöÊåâÈàïÔºåÈò≤Ê≠¢ÈáçË§áÈªûÊìä
    } else {
        // Á≠îÊ°àÈåØË™§
        playAudio(wrongAudio);
        changeEmoji(false);
        updateErrorRecord(idiom.ÊàêË™û);
		answerArea.classList.add('shake');

		setTimeout(() => {
			answerArea.classList.remove('shake');
			// Â∞áÁ≠îÊ°àÂçÄÁöÑÂÖÉÁ¥†‰æùÂ∫èÁßªÂõûÈÅ∏È†ÖÂçÄ
			const answerElements = Array.from(answerArea.children);
			answerElements.forEach(char => {
				// ÊâæÂà∞Â∞çÊáâÁöÑÂéüÂßãÈÅ∏È†Ö
				const originalOption = Array.from(characterOptions.children)
					.find(el => el.textContent === char.textContent && el.style.display === 'none');
				
				if (originalOption) {
					// Â¶ÇÊûúÊâæÂà∞ÂéüÂßãÈÅ∏È†ÖÔºåÂâáÊÅ¢Âæ©ÂÖ∂È°ØÁ§∫
					originalOption.style.display = '';
				} else {
					// Â¶ÇÊûúÊ≤íÊâæÂà∞ÂéüÂßãÈÅ∏È†ÖÔºà‰∏çÊáâË©≤ÁôºÁîüÔºâÔºåÂâáÂâµÂª∫‰∏ÄÂÄãÊñ∞ÁöÑ
					const newOption = char.cloneNode(true);
					newOption.classList.remove('in-answer');
					newOption.classList.add('character-option');
					characterOptions.appendChild(newOption);
				}
				
				// ÁßªÈô§Á≠îÊ°àÂçÄÁöÑÂÖÉÁ¥†
				char.remove();
			});
		}, 1000);
        
        checkButton.disabled = true; // ÈáçÁΩÆÂæåÁ¶ÅÁî®Á¢∫ÂÆöÊåâÈàï
    }
    totalPairs++;
}

        document.getElementById('next-button').onclick = function() {
            hideNextButton();
			hideEndButton();
            startNewRound();
        };

document.getElementById('start-button').onclick = function() {
    matchType = document.getElementById('match-type-select').value;
    document.getElementById('setup').classList.remove('active');
    document.getElementById('setup').style.display = 'none';
    document.getElementById('game').classList.add('active');
    document.getElementById('game').style.display = 'block';

    currentIndex = 0;
    currentRound = 0;
    orderedIdioms = [];
    startNewRound();
};

document.getElementById('close-button').onclick = function() {
    resetGame();	
};



document.getElementById('view-idioms-button').onclick = function() {
	currentFont = 'BpmfZihiSans-Regular';
	currentFontState = 'zih';
	currentFontSize = '1.3em';
    const fontToggleButton = document.getElementById('font-toggle-button');
	const ListfontToggleButton = document.getElementById('list-font-toggle-button');
	fontToggleButton.textContent = 'Â≠ó';
	ListfontToggleButton.textContent = 'Â≠ó';
    document.getElementById('setup').style.display = 'none';
    document.getElementById('idiom-list').style.display = 'block';
    renderIdiomList(); 
};

document.getElementById('close-idiom-list').onclick = function() {
    document.getElementById('idiom-list').style.display = 'none';
    document.getElementById('setup').style.display = 'block';
};



function replaceIdiomWithUnderscore(sentence, idiom) {
    return sentence.replace(new RegExp(idiom, 'g'), 'üôà');
}

function renderIdiomList() {
    const selectedCategory = document.getElementById('category-select').value;
    const table = document.getElementById('idiom-table');
    const tbody = table.querySelector('tbody');
    tbody.innerHTML = '';

    // ÁØ©ÈÅ∏ÊàêË™û
    let filteredIdioms;
    if (selectedCategory === 'Â∏∏ÈåØÊåëÊà∞') {
        const errorRecords = getErrorRecords();
        filteredIdioms = idioms.filter(idiom => errorRecords.hasOwnProperty(idiom.ÊàêË™û));
        filteredIdioms.sort((a, b) => errorRecords[b.ÊàêË™û] - errorRecords[a.ÊàêË™û]);
    } else {
        filteredIdioms = selectedCategory === 'all' 
            ? idioms 
            : idioms.filter(idiom => idiom.ÂàÜÈ°û === selectedCategory);
    }

    filteredIdioms.forEach((idiom, index) => {
        const randomExample = getRandomExample(idiom.‰æãÂè•);
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="category"><small>${idiom.ÂàÜÈ°û}</small></td>
            <td><small class="small-number">${index + 1} </small><span class="idiom">${idiom.ÊàêË™û}</span></td>
            <td class="literal">${idiom.Â≠óÈù¢ÊÑèÊÄù}</td>
            <td class="figurative">${idiom.Ë°®ÈÅîÊÑèÊÄù}</td>
            <td class="example">${replaceIdiomWithUnderscore(randomExample, idiom.idiomNoBPM)}</td>
        `;
        tbody.appendChild(row);
    });

	const idiomList = document.querySelectorAll('.idiom');
    idiomList.forEach(item => {
		item.style.fontFamily = currentFont;
    });

    updateVisibility();
    updateCategoryNavigation();
}

function updateVisibility() {
    const showCategory = document.getElementById('show-category').checked;
    const showIdiom = document.getElementById('show-idiom').checked;
    const showLiteral = document.getElementById('show-literal').checked;
    const showFigurative = document.getElementById('show-figurative').checked;
    const showExample = document.getElementById('show-example').checked;

    document.querySelectorAll('#idiom-table .category').forEach(el => el.style.display = showCategory ? '' : 'none');
    document.querySelectorAll('#idiom-table .idiom').forEach(el => el.style.display = showIdiom ? '' : 'none');
    document.querySelectorAll('#idiom-table .literal').forEach(el => el.style.display = showLiteral ? '' : 'none');
    document.querySelectorAll('#idiom-table .figurative').forEach(el => el.style.display = showFigurative ? '' : 'none');
    document.querySelectorAll('#idiom-table .example').forEach(el => el.style.display = showExample ? '' : 'none');
}

document.querySelectorAll('.idiom-controls input[type="checkbox"]').forEach(checkbox => {
    checkbox.addEventListener('change', updateVisibility);
});

document.getElementById('category-select').addEventListener('change', function() {
    renderIdiomList();
    updateCategoryNavigation();
});

function updateCategoryNavigation() {
    const categorySelect = document.getElementById('category-select');
    const prevButton = document.getElementById('prev-category');
    const nextButton = document.getElementById('next-category');
    const categories = Array.from(categorySelect.options).map(option => option.value);
    currentCategoryIndex = categories.indexOf(categorySelect.value);

    prevButton.disabled = currentCategoryIndex <= 1;  // Á¶ÅÁî®"ÂÖ®ÈÉ®"ÁöÑ‰∏ä‰∏ÄÂÄã
    nextButton.disabled = currentCategoryIndex >= categories.length - 1;

    if (currentCategoryIndex > 0) {
        prevButton.textContent = "< "  + categories[currentCategoryIndex - 1];
    }
    if (currentCategoryIndex < categories.length - 1) {
        nextButton.textContent = categories[currentCategoryIndex + 1] + " >";
    }
}

function changeCategory(direction) {
    const categorySelect = document.getElementById('category-select');
    const categories = Array.from(categorySelect.options).map(option => option.value);
    
    currentCategoryIndex += direction;
    if (currentCategoryIndex < 1) currentCategoryIndex = 1;  // ‰∏çË¶ÅÈÅ∏Âà∞"ÂÖ®ÈÉ®"
    if (currentCategoryIndex >= categories.length) currentCategoryIndex = categories.length - 1;

    categorySelect.value = categories[currentCategoryIndex];
    renderIdiomList();
    updateCategoryNavigation();
}

document.getElementById('prev-category').onclick = () => changeCategory(-1);
document.getElementById('next-category').onclick = () => changeCategory(1);

updateCategoryNavigation();

document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('font-toggle-button').addEventListener('click', toggleFont);
	document.getElementById('list-font-toggle-button').addEventListener('click', toggleFont);	
});

document.getElementById('clear-records').onclick = function() {
    if (confirm('Á¢∫ÂÆöË¶ÅÊ∏ÖÈô§ÊâÄÊúâÈåØË™§Ë®òÈåÑÂóéÔºü')) {
        clearErrorRecords();
        alert('ÈåØË™§Ë®òÈåÑÂ∑≤Ê∏ÖÈô§');        
        // Ê∏ÖÈô§Ë®òÈåÑÂæåÔºåÈúÄË¶ÅÊõ¥Êñ∞È°ûÂà•ÂàóË°®ÔºåÁßªÈô§„ÄåÂ∏∏ÈåØÊåëÊà∞„ÄçÈÅ∏È†Ö
        initializeCategories();
        
        // Â¶ÇÊûúÁï∂ÂâçÂú®„ÄåÂ∏∏ÈåØÊåëÊà∞„ÄçÈ°ûÂà•ÔºåÂâáÂàáÊèõÂà∞„ÄåÊâÄÊúâÂàÜÈ°û„Äç
        if (categorySelect.value === 'Â∏∏ÈåØÊåëÊà∞') {
            categorySelect.value = 'all';
        }        
        // Êõ¥Êñ∞È°ûÂà•Â∞éËà™ÊåâÈàï
        updateCategoryNavigation();
        // Êõ¥Êñ∞Ê∏ÖÈô§Á¥ÄÈåÑÊåâÈàïÁãÄÊÖã
        updateClearRecordsButton();
    }
};

function initializeCategories() {
    const categories = ['all', ...new Set(idioms.map(idiom => idiom.ÂàÜÈ°û))];
    const categorySelect = document.getElementById('category-select');
    categorySelect.innerHTML = '';

    categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category === 'all' ? 'all' : category;
        option.textContent = category === 'all' ? 'ÊâÄÊúâÂàÜÈ°û' : category;
        categorySelect.appendChild(option);
    });

    const errorRecords = getErrorRecords();
    if (Object.keys(errorRecords).length > 0) {
        const errorOption = document.createElement('option');
        errorOption.value = 'Â∏∏ÈåØÊåëÊà∞';
        errorOption.textContent = 'Â∏∏ÈåØÊåëÊà∞';
        categorySelect.appendChild(errorOption);
    }
}

function updateClearRecordsButton() {
    const clearRecordsButton = document.getElementById('clear-records');
    const errorRecords = getErrorRecords();
    const hasErrors = Object.keys(errorRecords).length > 0;
    
    clearRecordsButton.disabled = !hasErrors;
    clearRecordsButton.style.opacity = hasErrors ? '1' : '0.5';
    clearRecordsButton.style.cursor = hasErrors ? 'pointer' : 'not-allowed';
}

// Âú®È†ÅÈù¢ËºâÂÖ•ÊôÇË™øÁî®Ê≠§ÂáΩÊï∏
document.addEventListener('DOMContentLoaded', initializeCategories);

    </script>
<script src="https://y.yay.boo/y.js"></script>
</body>
</html>
